<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Prompt Builder - DevChef Tool</title>
</head>
<body>

<!-- DevChef Manifest -->
<script type="devchef-manifest">
{
  "id": "ai-prompt-builder",
  "name": "AI Prompt Builder",
  "category": "Developer Tools",
  "description": "Compose AI prompts with personas, tech stacks, templates, placeholders, and shareable links",
  "keywords": ["ai", "prompt", "llm", "chatgpt", "claude", "composer", "rules", "personas", "templates", "sharing"],
  "version": "3.0.0"
}
</script>

<!-- Tool UI Template -->
<template id="tool-ui">
  <div class="tool-container">
    <div class="tool-header">
      <h2 class="tool-title">AI Prompt Builder</h2>
      <p class="tool-description">Compose structured prompts with selectable personas and tech stack awareness</p>
    </div>

    <div class="tool-layout">
      <!-- Left Panel: Components -->
      <div class="components-panel">
        <div class="panel-header">
          <h3>Prompt Components</h3>
          <div class="panel-actions">
            <button id="import-file-btn" class="icon-btn" title="Import package.json / requirements.txt">üìÇ</button>
            <button id="import-config-btn" class="icon-btn" title="Import Configuration">üì•</button>
            <button id="export-config-btn" class="icon-btn" title="Export Configuration">üì§</button>
            <button id="reset-config-btn" class="icon-btn" title="Reset to Default">üîÑ</button>
          </div>
        </div>

        <div class="drop-zone" id="drop-zone">
          <div class="drop-zone-content">
            <div class="drop-icon">üìÅ</div>
            <div class="drop-text">Drop package.json or requirements.txt</div>
            <div class="drop-subtext">to auto-generate tech stack context</div>
          </div>
        </div>

        <div id="components-list" class="components-list">
          <!-- Components will be rendered here -->
        </div>

        <div class="add-component-section">
          <input type="text" id="new-component-name" placeholder="New component name..." />
          <button id="add-component-btn">+ Add Component</button>
        </div>
      </div>

      <!-- Right Panel: Preview & Export -->
      <div class="preview-panel">
        <div class="panel-header">
          <h3>Final Prompt</h3>
          <div class="panel-actions">
            <select id="export-format" class="format-select">
              <option value="structured">Structured</option>
              <option value="markdown">Markdown</option>
              <option value="plain">Plain Text</option>
            </select>
            <button id="share-btn" class="secondary" title="Share Configuration">üîó Share</button>
            <button id="copy-prompt-btn" class="primary">üìã Copy</button>
            <button id="save-prompt-btn" class="secondary">üíæ Save</button>
          </div>
        </div>

        <div class="preview-area">
          <textarea id="final-prompt" readonly placeholder="Your composed prompt will appear here..."></textarea>
        </div>

        <div class="stats-bar">
          <span id="char-count">0 characters</span>
          <span id="word-count">0 words</span>
          <span id="line-count">0 lines</span>
          <span id="placeholder-count">0 placeholders</span>
        </div>

        <div class="placeholders-section">
          <div class="section-header collapsible" id="placeholders-header">
            <label class="section-label">Placeholders <span id="placeholder-badge" class="count-badge">0</span></label>
            <button class="collapse-btn">‚ñº</button>
          </div>
          <div class="placeholders-content" id="placeholders-content">
            <div id="placeholders-list" class="placeholders-list">
              <p class="empty-state">No placeholders found. Use {{placeholder}} syntax in your components.</p>
            </div>
            <div class="placeholders-actions">
              <button id="fill-placeholders-btn" class="secondary">‚úì Apply Values</button>
              <button id="clear-placeholders-btn" class="secondary">‚úó Clear All</button>
            </div>
          </div>
        </div>

        <div class="templates-section">
          <div class="section-header collapsible" id="templates-header">
            <label class="section-label">Templates</label>
            <div class="template-actions">
              <button id="save-template-btn" class="icon-btn" title="Save as Template">üíæ</button>
              <button class="collapse-btn">‚ñº</button>
            </div>
          </div>
          <div class="templates-content" id="templates-content">
            <div class="template-filter">
              <input type="text" id="template-search" placeholder="Search templates..." />
              <select id="template-category" class="category-select">
                <option value="">All Categories</option>
                <option value="development">Development</option>
                <option value="writing">Writing</option>
                <option value="analysis">Analysis</option>
                <option value="documentation">Documentation</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="templates-grid" id="templates-grid">
              <!-- Templates will be rendered here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="file-input" accept=".json" style="display: none;">
    <input type="file" id="project-file-input" accept=".json,.txt" style="display: none;">
    <div id="status-message" class="status-message"></div>

    <!-- Persona Selection Modal -->
    <div id="persona-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Select a Persona</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="personas-grid" id="personas-grid">
            <!-- Personas will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Tech Stack Selection Modal -->
    <div id="techstack-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Select Technology Stack</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="techstack-search">
            <input type="text" id="techstack-search" placeholder="Search technologies..." />
          </div>
          <div class="techstack-grid" id="techstack-grid">
            <!-- Tech stacks will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Share Configuration</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="share-section">
            <label class="share-label">Shareable Link</label>
            <div class="share-input-group">
              <input type="text" id="share-link" readonly class="share-link-input" />
              <button id="copy-link-btn" class="primary">üìã Copy</button>
            </div>
            <p class="share-hint">Share this link with others to import your configuration</p>
          </div>
          <div class="share-section">
            <label class="share-label">QR Code</label>
            <div class="qr-container">
              <canvas id="qr-canvas" width="200" height="200"></canvas>
            </div>
            <button id="download-qr-btn" class="secondary">üíæ Download QR</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Template Modal -->
    <div id="save-template-modal" class="modal">
      <div class="modal-content modal-small">
        <div class="modal-header">
          <h3>Save as Template</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Template Name</label>
            <input type="text" id="template-name" placeholder="e.g., My Custom Template" class="form-input" />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="template-description" placeholder="Brief description of this template..." class="form-input" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Category</label>
            <select id="template-category-select" class="form-input">
              <option value="custom">Custom</option>
              <option value="development">Development</option>
              <option value="writing">Writing</option>
              <option value="analysis">Analysis</option>
              <option value="documentation">Documentation</option>
            </select>
          </div>
          <div class="modal-actions">
            <button id="save-template-confirm-btn" class="primary">üíæ Save Template</button>
            <button class="secondary modal-close">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Tool Styles -->
<style>
  .tool-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }

  .components-panel,
  .preview-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 250px);
  }

  .panel-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-primary);
  }

  .panel-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .panel-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .icon-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .icon-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--primary-color);
  }

  .format-select {
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
  }

  .format-select:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .drop-zone {
    margin: 12px;
    padding: 30px;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: var(--bg-primary);
  }

  .drop-zone:hover,
  .drop-zone.dragover {
    border-color: var(--primary-color);
    background: var(--bg-hover);
  }

  .drop-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.6;
  }

  .drop-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .drop-subtext {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .components-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
  }

  .component-item {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 12px;
    overflow: hidden;
    transition: all 0.2s;
  }

  .component-item.active {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 1px var(--primary-color);
  }

  .component-item.has-options {
    border-left: 3px solid var(--primary-color);
  }

  .component-header {
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg-secondary);
    cursor: pointer;
    user-select: none;
  }

  .component-header:hover {
    background: var(--bg-hover);
  }

  .component-toggle {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border-color);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .component-toggle.checked {
    background: var(--primary-color);
    border-color: var(--primary-color);
  }

  .component-toggle.checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
  }

  .component-name {
    flex: 1;
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
  }

  .component-badge {
    font-size: 11px;
    padding: 2px 8px;
    background: var(--primary-color);
    color: white;
    border-radius: 10px;
    font-weight: 500;
  }

  .component-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .component-header:hover .component-actions {
    opacity: 1;
  }

  .component-action {
    background: transparent;
    border: none;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
    border-radius: 3px;
    transition: background 0.2s;
  }

  .component-action:hover {
    background: var(--bg-primary);
  }

  .component-body {
    padding: 12px;
    display: none;
  }

  .component-item.expanded .component-body {
    display: block;
  }

  .component-body textarea {
    width: 100%;
    min-height: 100px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 13px;
    resize: vertical;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .component-body textarea:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .component-select-btn {
    width: 100%;
    padding: 10px;
    margin-bottom: 8px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.2s;
  }

  .component-select-btn:hover {
    background: var(--primary-hover);
  }

  .component-option-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .component-option-group .component-select-btn {
    width: auto;
    margin-bottom: 0;
    white-space: nowrap;
  }

  .component-select-label {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .component-preset-select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 13px;
  }

  .component-preset-select:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .component-meta {
    display: flex;
    gap: 12px;
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .add-component-section {
    padding: 12px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 8px;
  }

  #new-component-name {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  #new-component-name:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  #add-component-btn {
    padding: 8px 16px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.2s;
  }

  #add-component-btn:hover {
    background: var(--primary-hover);
  }

  .preview-area {
    flex: 1;
    padding: 16px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  #final-prompt {
    flex: 1;
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.6;
    resize: none;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  #final-prompt:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .stats-bar {
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 24px;
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--bg-primary);
    flex-wrap: wrap;
  }

  .templates-section {
    padding: 16px;
    border-top: 1px solid var(--border-color);
  }

  .templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
    margin-top: 12px;
  }

  .template-btn {
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    color: var(--text-primary);
  }

  .template-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }

  .status-message {
    margin-top: 16px;
    padding: 12px;
    border-radius: 4px;
    font-size: 13px;
    display: none;
  }

  .status-message.show {
    display: block;
  }

  .status-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .status-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .status-message.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: var(--bg-primary);
    border-radius: 8px;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: var(--text-primary);
  }

  .modal-close {
    background: transparent;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .modal-close:hover {
    background: var(--bg-hover);
  }

  .modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }

  .personas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
  }

  .persona-card {
    padding: 16px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-secondary);
  }

  .persona-card:hover {
    border-color: var(--primary-color);
    background: var(--bg-hover);
  }

  .persona-card.selected {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: white;
  }

  .persona-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 8px;
  }

  .persona-description {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.4;
  }

  .persona-card.selected .persona-description {
    color: rgba(255, 255, 255, 0.9);
  }

  .techstack-search {
    margin-bottom: 16px;
  }

  .techstack-search input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .techstack-search input:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .techstack-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 8px;
  }

  .techstack-item {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    background: var(--bg-secondary);
    font-size: 13px;
    font-weight: 500;
  }

  .techstack-item:hover {
    border-color: var(--primary-color);
    background: var(--bg-hover);
  }

  .techstack-item.selected {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: white;
  }

  /* Placeholders Section */
  .placeholders-section {
    padding: 16px;
    border-top: 1px solid var(--border-color);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    cursor: pointer;
    user-select: none;
  }

  .section-header.collapsible:hover {
    background: var(--bg-hover);
    margin: -4px -8px 12px -8px;
    padding: 4px 8px;
    border-radius: 4px;
  }

  .section-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .count-badge {
    background: var(--primary-color);
    color: white;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
  }

  .collapse-btn {
    background: transparent;
    border: none;
    font-size: 12px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 4px;
    transition: transform 0.2s;
  }

  .section-header.collapsed .collapse-btn {
    transform: rotate(-90deg);
  }

  .placeholders-content,
  .templates-content {
    transition: max-height 0.3s ease-out;
    overflow: hidden;
  }

  .section-header.collapsed + .placeholders-content,
  .section-header.collapsed + .templates-content {
    max-height: 0 !important;
  }

  .placeholders-list {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 12px;
  }

  .empty-state {
    text-align: center;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 20px;
    font-style: italic;
  }

  .placeholder-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    padding: 8px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
  }

  .placeholder-name {
    flex: 0 0 auto;
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--primary-color);
    font-weight: 500;
    min-width: 120px;
  }

  .placeholder-input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    font-size: 12px;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .placeholder-input:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .placeholder-input.filled {
    background: var(--bg-hover);
    border-color: var(--primary-color);
  }

  .placeholders-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  /* Template Enhancements */
  .template-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .template-filter {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .template-filter input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .template-filter input:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .category-select {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
  }

  .category-select:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .template-btn {
    position: relative;
  }

  .template-btn .template-category-tag {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 9px;
    padding: 2px 4px;
    background: var(--bg-secondary);
    border-radius: 2px;
    opacity: 0.7;
  }

  .template-btn.custom-template {
    border-left: 3px solid var(--primary-color);
  }

  .template-btn.custom-template .delete-template-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 3px;
    padding: 2px 4px;
    font-size: 10px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .template-btn.custom-template:hover .delete-template-btn {
    opacity: 1;
  }

  /* Share Modal */
  .share-section {
    margin-bottom: 24px;
  }

  .share-section:last-child {
    margin-bottom: 0;
  }

  .share-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .share-input-group {
    display: flex;
    gap: 8px;
  }

  .share-link-input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 12px;
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .share-link-input:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .share-hint {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 8px;
    font-style: italic;
  }

  .qr-container {
    display: flex;
    justify-content: center;
    padding: 20px;
    background: white;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  #qr-canvas {
    border: 1px solid var(--border-color);
    border-radius: 4px;
  }

  /* Save Template Modal */
  .modal-small {
    max-width: 500px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
  }

  .form-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-family: inherit;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  button.secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  button.secondary:hover {
    background: var(--bg-hover);
  }

  @media (max-width: 1024px) {
    .tool-layout {
      grid-template-columns: 1fr;
    }

    .personas-grid {
      grid-template-columns: 1fr;
    }

    .techstack-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
  }
</style>

<!-- Tool Module -->
<script type="module">
  // Persona library
  const PERSONAS = [
    {
      id: 'senior-engineer',
      name: 'Senior Software Engineer',
      description: 'Expert in modern development practices, design patterns, and clean code principles.',
      content: 'You are a senior software engineer with 10+ years of experience in modern development practices, design patterns, and clean code principles. You have deep expertise in software architecture, code quality, and best practices.'
    },
    {
      id: 'code-reviewer',
      name: 'Code Reviewer',
      description: 'Focused on code quality, security, performance, and maintainability.',
      content: 'You are a meticulous code reviewer with expertise in identifying code quality issues, security vulnerabilities, performance bottlenecks, and maintainability concerns. You provide constructive feedback focused on best practices.'
    },
    {
      id: 'architect',
      name: 'Solution Architect',
      description: 'Designs scalable, maintainable systems with focus on architecture patterns.',
      content: 'You are a solution architect specializing in designing scalable, maintainable, and robust systems. You have expertise in architectural patterns, system design, microservices, and cloud architecture.'
    },
    {
      id: 'devops-engineer',
      name: 'DevOps Engineer',
      description: 'Expert in CI/CD, infrastructure, containers, and automation.',
      content: 'You are a DevOps engineer with expertise in CI/CD pipelines, infrastructure as code, containerization (Docker, Kubernetes), cloud platforms (AWS, Azure, GCP), and automation.'
    },
    {
      id: 'security-expert',
      name: 'Security Expert',
      description: 'Focuses on security best practices, vulnerabilities, and secure coding.',
      content: 'You are a security expert specializing in application security, secure coding practices, vulnerability assessment, and security best practices. You focus on OWASP top 10, authentication, authorization, and data protection.'
    },
    {
      id: 'data-analyst',
      name: 'Data Analyst',
      description: 'Expert in statistical analysis, data visualization, and insights.',
      content: 'You are a data analyst with expertise in statistical analysis, data visualization, SQL, Python/R, and extracting actionable insights from data. You understand data cleaning, transformation, and storytelling.'
    },
    {
      id: 'frontend-specialist',
      name: 'Frontend Specialist',
      description: 'Expert in modern frontend frameworks, UX, and web performance.',
      content: 'You are a frontend specialist with deep knowledge of React, Vue, Angular, TypeScript, CSS, and modern web development. You understand UX principles, accessibility, and web performance optimization.'
    },
    {
      id: 'backend-specialist',
      name: 'Backend Specialist',
      description: 'Expert in APIs, databases, server architecture, and scalability.',
      content: 'You are a backend specialist with expertise in REST/GraphQL APIs, database design, server architecture, caching strategies, and building scalable backend systems. You know Node.js, Python, Java, Go, and database technologies.'
    },
    {
      id: 'tech-educator',
      name: 'Technical Educator',
      description: 'Explains complex concepts in simple, understandable terms.',
      content: 'You are a technical educator who excels at breaking down complex technical concepts into simple, understandable explanations. You use analogies, examples, and step-by-step breakdowns to teach effectively.'
    },
    {
      id: 'qa-engineer',
      name: 'QA Engineer',
      description: 'Expert in testing strategies, test automation, and quality assurance.',
      content: 'You are a QA engineer with expertise in testing strategies, test automation, unit/integration/e2e testing, and quality assurance best practices. You understand testing frameworks and ensure software reliability.'
    },
    {
      id: 'technical-writer',
      name: 'Technical Writer',
      description: 'Creates clear documentation, API docs, and technical content.',
      content: 'You are a technical writer specializing in creating clear, comprehensive documentation, API documentation, user guides, and technical content. You understand how to make complex technical information accessible.'
    },
    {
      id: 'content-writer',
      name: 'Content Writer',
      description: 'Professional writer for blogs, marketing, and storytelling.',
      content: 'You are a professional content writer with expertise in technical writing, copywriting, blog posts, marketing content, and storytelling. You adapt tone and style to the target audience.'
    }
  ];

  // Technology stack library
  const TECH_STACKS = {
    'Frontend': ['React', 'Vue.js', 'Angular', 'Svelte', 'Next.js', 'Nuxt.js', 'TypeScript', 'JavaScript', 'HTML/CSS', 'Tailwind CSS', 'Bootstrap'],
    'Backend': ['Node.js', 'Python', 'Java', 'Go', 'Rust', 'PHP', 'Ruby', 'C#/.NET', 'Elixir', 'Scala'],
    'Frameworks': ['Express.js', 'Django', 'Flask', 'FastAPI', 'Spring Boot', 'Laravel', 'Ruby on Rails', 'ASP.NET Core'],
    'Databases': ['PostgreSQL', 'MySQL', 'MongoDB', 'Redis', 'Elasticsearch', 'SQLite', 'DynamoDB', 'Cassandra', 'Neo4j'],
    'Cloud': ['AWS', 'Azure', 'Google Cloud', 'Vercel', 'Netlify', 'Heroku', 'DigitalOcean', 'Cloudflare'],
    'DevOps': ['Docker', 'Kubernetes', 'Jenkins', 'GitHub Actions', 'GitLab CI', 'Terraform', 'Ansible', 'Prometheus', 'Grafana'],
    'Mobile': ['React Native', 'Flutter', 'Swift', 'Kotlin', 'Ionic', 'Xamarin'],
    'Data': ['Pandas', 'NumPy', 'TensorFlow', 'PyTorch', 'Scikit-learn', 'Apache Spark', 'Airflow', 'Jupyter']
  };

  const COMPONENT_PRESETS = {
    'context': [
      {
        id: 'project-brief',
        name: 'Project Brief',
        content: 'Project: {{project_name}}\nDomain: {{domain}}\nKey requirements: {{requirements}}\nPrimary users: {{primary_users}}\nSuccess metric: {{success_metric}}'
      },
      {
        id: 'incident-summary',
        name: 'Incident / Bug Context',
        content: 'Issue: {{issue_summary}}\nSeverity: {{severity}}\nAffected components: {{components}}\nUser impact: {{impact}}\nLogs/links: {{references}}'
      },
      {
        id: 'meeting-context',
        name: 'Meeting Recap Context',
        content: 'Meeting type: {{meeting_type}}\nDate: {{date}}\nAttendees: {{attendees}}\nGoal: {{goal}}\nNotes: {{notes}}'
      },
      {
        id: 'codebase-context',
        name: 'Codebase / Repository Context',
        content: 'Repository: {{repo_name}}\nLanguages/frameworks: {{tech_stack}}\nArchitecture: {{architecture_pattern}}\nCode standards: {{standards}}\nRelated files: {{related_files}}'
      },
      {
        id: 'user-story-context',
        name: 'User Story Context',
        content: 'As a {{user_role}}\nI want {{user_goal}}\nSo that {{user_benefit}}\nAcceptance criteria: {{acceptance_criteria}}'
      },
      {
        id: 'api-integration-context',
        name: 'API Integration Context',
        content: 'API: {{api_name}}\nVersion: {{api_version}}\nAuthentication: {{auth_method}}\nEndpoints: {{endpoints}}\nRate limits: {{rate_limits}}\nDocumentation: {{docs_link}}'
      },
      {
        id: 'performance-context',
        name: 'Performance / Optimization Context',
        content: 'Current metrics: {{current_metrics}}\nTarget metrics: {{target_metrics}}\nBottlenecks: {{bottlenecks}}\nConstraints: {{constraints}}\nMonitoring: {{monitoring_tools}}'
      }
    ],
    'task': [
      {
        id: 'feature-task',
        name: 'Feature Implementation',
        content: 'Objective: {{feature_summary}}\nCurrent behavior: {{current_behavior}}\nDesired behavior: {{desired_behavior}}\nAcceptance criteria: {{acceptance_criteria}}'
      },
      {
        id: 'bugfix-task',
        name: 'Bug Fix / Investigation',
        content: 'Bug: {{bug_summary}}\nSteps to reproduce: {{steps}}\nExpected vs actual: {{expected_vs_actual}}\nDiagnostics collected: {{diagnostics}}'
      },
      {
        id: 'analysis-task',
        name: 'Analysis / Research Objective',
        content: 'Dataset or subject: {{subject}}\nQuestions to answer: {{questions}}\nConstraints: {{analysis_constraints}}\nSuccess looks like: {{success_definition}}'
      },
      {
        id: 'refactoring-task',
        name: 'Code Refactoring',
        content: 'Code to refactor: {{code_location}}\nCurrent issues: {{issues}}\nRefactoring goals: {{goals}}\nMust preserve: {{preserve}}\nTest coverage: {{test_coverage}}'
      },
      {
        id: 'documentation-task',
        name: 'Documentation Writing',
        content: 'What to document: {{subject}}\nTarget audience: {{audience}}\nDocumentation type: {{doc_type}}\nExisting docs: {{existing_docs}}\nKey points to cover: {{key_points}}'
      },
      {
        id: 'review-task',
        name: 'Code / PR Review',
        content: 'PR/Code: {{pr_number}}\nChanges summary: {{changes_summary}}\nFiles changed: {{files}}\nReview focus: {{review_focus}}\nContext: {{context}}'
      },
      {
        id: 'migration-task',
        name: 'Migration / Upgrade',
        content: 'Migrate from: {{from_version}}\nMigrate to: {{to_version}}\nScope: {{scope}}\nBreaking changes: {{breaking_changes}}\nRollback plan: {{rollback}}'
      },
      {
        id: 'testing-task',
        name: 'Test Writing',
        content: 'Code to test: {{code_location}}\nTest type: {{test_type}}\nCoverage goal: {{coverage_goal}}\nEdge cases: {{edge_cases}}\nTest data: {{test_data}}'
      }
    ],
    'rules': [
      {
        id: 'engineering-best-practices',
        name: 'Engineering Best Practices',
        content: `Follow these rules:\n- Cite relevant standards or RFCs when possible\n- Highlight risks, edge cases, and trade-offs\n- Prefer deterministic steps with measurable outcomes\n- Offer testing guidance for every recommendation\n- Keep explanations concise but technically rigorous`
      },
      {
        id: 'writing-voice',
        name: 'Writing Voice Guidelines',
        content: `Writing guidelines:\n- Maintain {{tone}} tone throughout\n- Favor short paragraphs and scannable bullets\n- Include concrete examples and analogies\n- Reference the target audience directly\n- Close with a clear call-to-action or summary`
      },
      {
        id: 'analysis-steps',
        name: 'Analytical Thinking Rules',
        content: `When reasoning:\n- Separate observations, inferences, and recommendations\n- Quantify impact whenever possible\n- Surface assumptions or missing data\n- Offer at least two solution paths\n- Note monitoring or follow-up signals`
      },
      {
        id: 'security-first',
        name: 'Security-First Approach',
        content: `Security guidelines:\n- Follow OWASP Top 10 best practices\n- Never expose sensitive data in logs or errors\n- Validate and sanitize all inputs\n- Use parameterized queries to prevent SQL injection\n- Implement proper authentication and authorization\n- Follow principle of least privilege`
      },
      {
        id: 'accessibility-standards',
        name: 'Accessibility Standards',
        content: `Accessibility rules:\n- Follow WCAG 2.1 AA standards\n- Ensure keyboard navigation support\n- Provide ARIA labels for screen readers\n- Maintain sufficient color contrast ratios\n- Include alt text for images\n- Test with assistive technologies`
      },
      {
        id: 'performance-optimization',
        name: 'Performance Optimization',
        content: `Performance rules:\n- Minimize network requests and payload sizes\n- Implement lazy loading for resources\n- Use caching strategies appropriately\n- Optimize database queries with indexes\n- Profile before optimizing\n- Set performance budgets and monitor`
      },
      {
        id: 'clean-code',
        name: 'Clean Code Principles',
        content: `Code quality rules:\n- Write self-documenting code with clear naming\n- Keep functions small and focused (single responsibility)\n- Avoid duplication (DRY principle)\n- Prefer composition over inheritance\n- Write tests alongside code\n- Refactor continuously`
      }
    ],
    'output-format': [
      {
        id: 'detailed-solution',
        name: 'Detailed Solution Outline',
        content: `Structure your response as:\n1. Brief summary (1-2 sentences)\n2. Detailed explanation with step-by-step breakdown\n3. Code examples with inline comments\n4. Testing approach and edge cases\n5. Best practices and recommendations`
      },
      {
        id: 'summary-output',
        name: 'Executive Summary + Table',
        content: `Provide:\n- Executive summary (3 bullets max)\n- Table with columns: Section | Details | Owner | ETA\n- Risks & mitigations\n- Follow-up questions for stakeholders\n- Resources or references for more depth`
      },
      {
        id: 'ticket-ready-output',
        name: 'Ticket-Ready Deliverable',
        content: `Format response for ticketing system:\n**Title:** ...\n**Problem Statement:** ...\n**Steps/Plan:** (numbered list)\n**Dependencies:** ...\n**Validation:** tests or acceptance criteria\n**Attachments:** code refs, diagrams, links`
      },
      {
        id: 'step-by-step',
        name: 'Step-by-Step Guide',
        content: `Provide a step-by-step guide:\n1. Prerequisites and setup\n2. Step 1: [Action] - [Expected result]\n3. Step 2: [Action] - [Expected result]\n...\nN. Verification steps\nTroubleshooting common issues`
      },
      {
        id: 'code-only',
        name: 'Code-Focused (Minimal Explanation)',
        content: `Provide:\n- Working code solution\n- Inline comments explaining key logic\n- Usage example\n- Brief notes on edge cases or gotchas`
      },
      {
        id: 'comparison-table',
        name: 'Comparison / Trade-offs Table',
        content: `Present as comparison table:\n| Approach | Pros | Cons | Best For | Complexity |\n|----------|------|------|----------|------------|\n| Option 1 | ... | ... | ... | ... |\n| Option 2 | ... | ... | ... | ... |\n\nRecommendation: [Your pick with reasoning]`
      },
      {
        id: 'eli5-format',
        name: 'ELI5 (Explain Like I\'m 5)',
        content: `Explain in simple terms:\n1. Simple analogy or metaphor\n2. Basic explanation without jargon\n3. Visual description or diagram in ASCII/markdown\n4. Simple example everyone can relate to\n5. Key takeaway in one sentence`
      },
      {
        id: 'markdown-documentation',
        name: 'Markdown Documentation',
        content: `Format as markdown documentation:\n# Title\n## Overview\n## Installation\n## Usage\n### Basic Example\n### Advanced Example\n## API Reference\n## FAQ\n## Contributing`
      },
      {
        id: 'json-structured',
        name: 'JSON Structured Output',
        content: `Return response as JSON:\n{\n  "summary": "...",\n  "solution": {...},\n  "examples": [...],\n  "alternatives": [...],\n  "resources": [...]\n}`
      }
    ],
    'constraints': [
      {
        id: 'delivery-constraints',
        name: 'Delivery Constraints',
        content: 'Timeline: {{deadline}}\nBudget: {{budget}}\nCritical dependencies: {{dependencies}}\nCompliance requirements: {{compliance}}'
      },
      {
        id: 'compliance-constraints',
        name: 'Compliance & Policy Constraints',
        content: 'Regulation: {{regulation}}\nData classification: {{data_level}}\nSecurity posture: {{security_requirements}}\nApproval needed from: {{approvers}}'
      },
      {
        id: 'resource-constraints',
        name: 'Resource Constraints',
        content: 'Team availability: {{team_availability}}\nTooling limitations: {{tooling_limits}}\nEnvironments: {{environments}}\nOperational support window: {{support_window}}'
      },
      {
        id: 'technical-constraints',
        name: 'Technical Constraints',
        content: 'Technology limitations: {{tech_limits}}\nBrowser/platform support: {{platform_support}}\nPerformance requirements: {{performance_reqs}}\nBackward compatibility: {{compatibility}}\nThird-party dependencies: {{third_party}}'
      },
      {
        id: 'scope-constraints',
        name: 'Scope Constraints',
        content: 'In scope: {{in_scope}}\nOut of scope: {{out_of_scope}}\nPhase 1 requirements: {{phase1}}\nFuture enhancements: {{future}}\nNon-goals: {{non_goals}}'
      },
      {
        id: 'quality-constraints',
        name: 'Quality Constraints',
        content: 'Code coverage minimum: {{coverage_min}}\nPerformance benchmarks: {{benchmarks}}\nAccessibility level: {{accessibility}}\nBrowser support: {{browsers}}\nUptime requirement: {{uptime}}'
      }
    ],
    'examples': [
      {
        id: 'before-after',
        name: 'Before vs After',
        content: 'Before: {{before_state}}\nAfter: {{after_state}}\nKey improvements: {{improvements}}'
      },
      {
        id: 'case-study',
        name: 'Case Study',
        content: 'Scenario: {{scenario}}\nActions taken: {{actions}}\nOutcome: {{outcome}}\nLessons learned: {{lessons}}'
      },
      {
        id: 'anti-patterns',
        name: 'Anti-pattern Watchlist',
        content: 'Anti-pattern: {{anti_pattern}}\nWhy it hurts: {{impact}}\nPreferred alternative: {{alternative}}\nDetection tips: {{detection}}'
      },
      {
        id: 'real-world-example',
        name: 'Real-world Example',
        content: 'Company/project: {{example_source}}\nChallenge: {{challenge}}\nSolution: {{solution}}\nResults: {{results}}\nSource: {{source_link}}'
      },
      {
        id: 'code-comparison',
        name: 'Code Comparison',
        content: 'Bad approach:\n```{{language}}\n{{bad_code}}\n```\n\nGood approach:\n```{{language}}\n{{good_code}}\n```\n\nWhy it\'s better: {{explanation}}'
      },
      {
        id: 'multiple-scenarios',
        name: 'Multiple Scenarios',
        content: 'Scenario A: {{scenario_a}} ‚Üí Solution: {{solution_a}}\nScenario B: {{scenario_b}} ‚Üí Solution: {{solution_b}}\nScenario C: {{scenario_c}} ‚Üí Solution: {{solution_c}}'
      }
    ]
  };

  // Default configuration with enhanced components
  const DEFAULT_CONFIG = {
    components: [
      {
        id: 'role',
        name: 'Role / Persona',
        enabled: true,
        order: 1,
        hasOptions: true,
        selectedPersona: 'senior-engineer',
        content: PERSONAS[0].content
      },
      {
        id: 'tech-stack',
        name: 'Technology Stack',
        enabled: true,
        order: 2,
        hasOptions: true,
        selectedStacks: [],
        content: 'Technology stack: {{tech_stack}}\n\nPlease provide solutions and examples specific to these technologies.'
      },
      {
        id: 'context',
        name: 'Context / Background',
        enabled: true,
        order: 3,
        hasOptions: true,
        selectedPreset: 'project-brief',
        content: 'Project: {{project_name}}
Domain: {{domain}}
Key requirements: {{requirements}}
Primary users: {{primary_users}}
Success metric: {{success_metric}}'
      },
      {
        id: 'task',
        name: 'Task / Objective',
        enabled: true,
        order: 4,
        hasOptions: true,
        selectedPreset: 'feature-task',
        content: 'Objective: {{feature_summary}}
Current behavior: {{current_behavior}}
Desired behavior: {{desired_behavior}}
Acceptance criteria: {{acceptance_criteria}}'
      },
      {
        id: 'rules',
        name: 'Processing Rules',
        enabled: true,
        order: 5,
        hasOptions: true,
        selectedPreset: 'engineering-best-practices',
        content: `Follow these rules:
- Cite relevant standards or RFCs when possible
- Highlight risks, edge cases, and trade-offs
- Prefer deterministic steps with measurable outcomes
- Offer testing guidance for every recommendation
- Keep explanations concise but technically rigorous`
      },
      {
        id: 'output-format',
        name: 'Output Format',
        enabled: true,
        order: 6,
        hasOptions: true,
        selectedPreset: 'detailed-solution',
        content: `Structure your response as:
1. Brief summary (1-2 sentences)
2. Detailed explanation with step-by-step breakdown
3. Code examples with inline comments
4. Testing approach and edge cases
5. Best practices and recommendations`
      },
      {
        id: 'constraints',
        name: 'Constraints / Limitations',
        enabled: false,
        order: 7,
        hasOptions: true,
        selectedPreset: 'delivery-constraints',
        content: 'Timeline: {{deadline}}
Budget: {{budget}}
Critical dependencies: {{dependencies}}
Compliance requirements: {{compliance}}'
      },
      {
        id: 'examples',
        name: 'Examples / References',
        enabled: false,
        order: 8,
        hasOptions: true,
        selectedPreset: 'before-after',
        content: 'Before: {{before_state}}
After: {{after_state}}
Key improvements: {{improvements}}'
      }
    ]
  };

  // Enhanced templates
  const TEMPLATES = {
    'code-review': {
      name: 'Code Review Assistant',
      category: 'development',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'code-reviewer',
          content: PERSONAS.find(p => p.id === 'code-reviewer').content
        },
        {
          id: 'task',
          name: 'Code to Review',
          enabled: true,
          order: 2,
          content: '{{code_snippet}}'
        },
        {
          id: 'rules',
          name: 'Review Criteria',
          enabled: true,
          order: 3,
          content: `Review the code for:
- Code quality and readability
- Performance issues and optimizations
- Security vulnerabilities (OWASP top 10)
- Best practices adherence
- Potential bugs and edge cases
- Maintainability and scalability concerns
- Test coverage gaps`
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Structure your review as:
1. Overall assessment (1-2 sentences)
2. Critical issues (MUST fix - security, bugs)
3. Important suggestions (SHOULD fix - performance, best practices)
4. Minor improvements (COULD fix - style, optimization)
5. Positive highlights (what's done well)
6. Refactored code example (if applicable)`
        }
      ]
    },
    'data-analysis': {
      name: 'Data Analysis Assistant',
      category: 'analysis',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'data-analyst',
          content: PERSONAS.find(p => p.id === 'data-analyst').content
        },
        {
          id: 'context',
          name: 'Dataset Context',
          enabled: true,
          order: 2,
          content: 'Dataset: {{dataset_name}}\nSource: {{data_source}}\nSize: {{record_count}} records\nKey fields: {{field_list}}\nTime period: {{time_period}}'
        },
        {
          id: 'task',
          name: 'Analysis Objective',
          enabled: true,
          order: 3,
          content: '{{analysis_objective}}'
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Provide:
1. Executive summary (key findings in 3-5 bullet points)
2. Statistical summary (mean, median, std dev, outliers)
3. Data quality assessment (missing values, anomalies)
4. Visualization recommendations (chart types, variables)
5. Actionable insights with business impact
6. Recommendations for next analysis steps
7. Python/SQL code snippets for analysis`
        }
      ]
    },
    'content-writer': {
      name: 'Content Writer',
      category: 'writing',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'content-writer',
          content: PERSONAS.find(p => p.id === 'content-writer').content
        },
        {
          id: 'task',
          name: 'Writing Brief',
          enabled: true,
          order: 2,
          content: 'Topic: {{topic}}\nTarget audience: {{audience}}\nTone: {{tone}}\nKey message: {{key_message}}'
        },
        {
          id: 'rules',
          name: 'Writing Guidelines',
          enabled: true,
          order: 3,
          content: `Guidelines:
- Use clear, engaging language appropriate for {{audience}}
- Maintain {{tone}} tone throughout
- Include concrete examples and case studies
- Break up text with subheadings and bullet points
- Use active voice and strong verbs
- End with clear call-to-action or key takeaways`
        },
        {
          id: 'constraints',
          name: 'Constraints',
          enabled: true,
          order: 4,
          content: 'Word count: {{word_count}}\nSEO keywords: {{keywords}}\nContent type: {{content_type}}'
        }
      ]
    },
    'tech-explainer': {
      name: 'Technical Explainer',
      category: 'writing',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'tech-educator',
          content: PERSONAS.find(p => p.id === 'tech-educator').content
        },
        {
          id: 'task',
          name: 'Concept to Explain',
          enabled: true,
          order: 2,
          content: 'Explain: {{technical_concept}}\nAudience level: {{beginner/intermediate/advanced}}'
        },
        {
          id: 'rules',
          name: 'Explanation Principles',
          enabled: true,
          order: 3,
          content: `Follow these principles:
- Start with a simple real-world analogy
- Build understanding from basics to advanced
- Use concrete examples and diagrams
- Avoid unnecessary jargon (or explain when needed)
- Include practical applications and use cases
- Address common misconceptions`
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Structure:
1. Simple analogy (ELI5 - Explain Like I'm 5)
2. Core concept explanation (what it is)
3. How it works (step-by-step breakdown)
4. Real-world examples and use cases
5. Benefits and trade-offs
6. Common misconceptions and FAQs
7. Next steps for deeper learning`
        }
      ]
    },
    'architect': {
      name: 'Solution Architect',
      category: 'development',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'architect',
          content: PERSONAS.find(p => p.id === 'architect').content
        },
        {
          id: 'tech-stack',
          name: 'Technology Stack',
          enabled: true,
          order: 2,
          hasOptions: true,
          selectedStacks: [],
          content: 'Technology stack: {{tech_stack}}'
        },
        {
          id: 'task',
          name: 'Architecture Challenge',
          enabled: true,
          order: 3,
          content: 'System to design: {{system_description}}\nScale: {{user_count}} users, {{request_rate}} requests/sec\nKey requirements: {{requirements}}'
        },
        {
          id: 'rules',
          name: 'Design Principles',
          enabled: true,
          order: 4,
          content: `Consider:
- Scalability and performance requirements
- Security and compliance needs
- High availability and fault tolerance
- Cost optimization
- Maintainability and developer experience
- Technology trade-offs and alternatives`
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 5,
          content: `Provide:
1. High-level architecture overview
2. Component breakdown with responsibilities
3. Data flow and communication patterns
4. Technology choices with justification
5. Scalability strategy
6. Security considerations
7. Potential bottlenecks and mitigation
8. Architecture diagram (ASCII or description)`
        }
      ]
    },
    'debugging': {
      name: 'Debugging Assistant',
      category: 'development',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'senior-engineer',
          content: 'You are a senior debugging expert with deep experience in troubleshooting complex issues across different technologies. You follow systematic debugging approaches and help identify root causes.'
        },
        {
          id: 'context',
          name: 'Environment',
          enabled: true,
          order: 2,
          content: 'Environment: {{environment}}\nTech stack: {{tech_stack}}\nError occurred: {{when_occurred}}'
        },
        {
          id: 'task',
          name: 'Issue Description',
          enabled: true,
          order: 3,
          content: 'Error message: {{error_message}}\n\nCode snippet:\n{{code_snippet}}\n\nExpected behavior: {{expected}}\nActual behavior: {{actual}}'
        },
        {
          id: 'rules',
          name: 'Debugging Approach',
          enabled: true,
          order: 4,
          content: `Follow systematic debugging:
1. Reproduce the issue
2. Isolate the root cause
3. Verify assumptions with evidence
4. Consider recent changes
5. Check logs and stack traces
6. Test hypotheses incrementally`
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 5,
          content: `Provide:
1. Root cause analysis (what's causing the issue)
2. Step-by-step fix with code examples
3. Why this solution works (explanation)
4. How to verify the fix
5. How to prevent similar issues
6. Additional debugging tips if issue persists`
        }
      ]
    },
    'api-documentation': {
      name: 'API Documentation',
      category: 'documentation',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'technical-writer',
          content: PERSONAS.find(p => p.id === 'technical-writer').content
        },
        {
          id: 'context',
          name: 'API Context',
          enabled: true,
          order: 2,
          content: 'API Name: {{api_name}}\nVersion: {{version}}\nBase URL: {{base_url}}\nAuthentication: {{auth_method}}'
        },
        {
          id: 'task',
          name: 'Documentation Scope',
          enabled: true,
          order: 3,
          content: 'Document the following endpoint(s):\n{{endpoints}}'
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Provide comprehensive API documentation with:
1. Endpoint overview and purpose
2. HTTP method and path
3. Request parameters (path, query, body)
4. Request/response examples (JSON)
5. Response codes and error handling
6. Authentication requirements
7. Rate limiting information
8. Code examples in multiple languages`
        }
      ]
    },
    'pr-review': {
      name: 'Pull Request Review',
      category: 'development',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'code-reviewer',
          content: PERSONAS.find(p => p.id === 'code-reviewer').content
        },
        {
          id: 'context',
          name: 'PR Context',
          enabled: true,
          order: 2,
          content: 'PR Title: {{pr_title}}\nBranch: {{branch_name}}\nFiles changed: {{file_count}}\nLines added/removed: {{line_stats}}'
        },
        {
          id: 'task',
          name: 'Changes to Review',
          enabled: true,
          order: 3,
          content: 'PR Description:\n{{pr_description}}\n\nCode diff:\n{{code_diff}}'
        },
        {
          id: 'rules',
          name: 'Review Criteria',
          enabled: true,
          order: 4,
          content: `Review for:
- Code quality and consistency with codebase
- Breaking changes and backward compatibility
- Test coverage for new features
- Documentation updates
- Security vulnerabilities
- Performance implications
- Edge cases handling`
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 5,
          content: `Structure your review as:
1. Summary (approve/request changes/comment)
2. Key observations (what the PR does well)
3. Required changes (blocking issues)
4. Suggested improvements (non-blocking)
5. Questions and clarifications
6. Testing recommendations`
        }
      ]
    },
    'technical-spec': {
      name: 'Technical Specification',
      category: 'documentation',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'architect',
          content: PERSONAS.find(p => p.id === 'architect').content
        },
        {
          id: 'context',
          name: 'Project Context',
          enabled: true,
          order: 2,
          content: 'Feature: {{feature_name}}\nStakeholders: {{stakeholders}}\nTimeline: {{timeline}}\nPriority: {{priority}}'
        },
        {
          id: 'task',
          name: 'Specification Scope',
          enabled: true,
          order: 3,
          content: 'Requirements:\n{{requirements}}\n\nConstraints:\n{{constraints}}'
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Create a technical specification with:
1. Executive Summary
2. Goals and Objectives
3. Functional Requirements
4. Technical Architecture
5. Data Models and Schemas
6. API Contracts
7. Security Considerations
8. Performance Requirements
9. Testing Strategy
10. Deployment Plan
11. Risks and Mitigation
12. Success Metrics`
        }
      ]
    },
    'user-story': {
      name: 'User Story Generator',
      category: 'documentation',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          hasOptions: true,
          selectedPersona: 'senior-engineer',
          content: 'You are a product-focused engineer skilled at writing clear, actionable user stories following Agile best practices.'
        },
        {
          id: 'context',
          name: 'Feature Context',
          enabled: true,
          order: 2,
          content: 'Feature: {{feature_name}}\nUser persona: {{user_persona}}\nBusiness goal: {{business_goal}}'
        },
        {
          id: 'task',
          name: 'Story Requirements',
          enabled: true,
          order: 3,
          content: 'User need:\n{{user_need}}\n\nExpected outcome:\n{{expected_outcome}}'
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Create user stories in this format:

**User Story:**
As a [user persona]
I want to [action/feature]
So that [benefit/value]

**Acceptance Criteria:**
- [ ] Criterion 1
- [ ] Criterion 2
- [ ] Criterion 3

**Technical Notes:**
- Implementation considerations
- Dependencies
- Edge cases

**Definition of Done:**
- Code complete and reviewed
- Tests written and passing
- Documentation updated
- Deployed to staging`
        }
      ]
    },
    'meeting-notes': {
      name: 'Meeting Notes',
      category: 'writing',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          content: 'You are an executive assistant skilled at creating clear, concise meeting summaries with actionable items.'
        },
        {
          id: 'context',
          name: 'Meeting Context',
          enabled: true,
          order: 2,
          content: 'Meeting: {{meeting_title}}\nDate: {{date}}\nAttendees: {{attendees}}\nDuration: {{duration}}'
        },
        {
          id: 'task',
          name: 'Meeting Content',
          enabled: true,
          order: 3,
          content: 'Raw notes or transcript:\n{{meeting_content}}'
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Structure the notes as:

**Meeting Overview**
- Purpose and objectives

**Key Discussion Points**
- Topic 1: Summary
- Topic 2: Summary
- Topic 3: Summary

**Decisions Made**
- Decision 1
- Decision 2

**Action Items**
- [ ] Task (Owner: Name, Due: Date)
- [ ] Task (Owner: Name, Due: Date)

**Next Steps**
- Follow-up items
- Next meeting date/topic

**Parking Lot**
- Items to revisit later`
        }
      ]
    },
    'email-writing': {
      name: 'Professional Email',
      category: 'writing',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          content: 'You are a professional communication specialist skilled at writing clear, effective business emails.'
        },
        {
          id: 'context',
          name: 'Email Context',
          enabled: true,
          order: 2,
          content: 'To: {{recipient}}\nPurpose: {{purpose}}\nTone: {{tone}} (formal/professional/friendly)\nUrgency: {{urgency}}'
        },
        {
          id: 'task',
          name: 'Email Content',
          enabled: true,
          order: 3,
          content: 'Key points to cover:\n{{key_points}}\n\nDesired outcome:\n{{desired_outcome}}'
        },
        {
          id: 'rules',
          name: 'Writing Guidelines',
          enabled: true,
          order: 4,
          content: `Follow these guidelines:
- Clear, descriptive subject line
- Professional greeting
- Concise, scannable paragraphs
- Bullet points for multiple items
- Clear call-to-action
- Professional sign-off
- Proofread for clarity and tone`
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 5,
          content: `Provide:
**Subject:** [Clear, actionable subject line]

**Email Body:**
[Well-structured email with greeting, body paragraphs, and closing]

**Alternative Subject Lines:** (2-3 options)
**Tone Analysis:** [How the email comes across]`
        }
      ]
    }
  };

  let state = {
    config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)),
    currentModal: null,
    placeholders: {}, // {placeholder_name: value}
    customTemplates: []
  };

  function normalizeComponents() {
    if (!state.config || !Array.isArray(state.config.components)) {
      state.config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
    }

    state.config.components.forEach((component, index) => {
      if (typeof component.order !== 'number') {
        component.order = index + 1;
      }

      if (component.id === 'role') {
        component.hasOptions = true;
        component.selectedPersona = resolvePersonaSelection(component);
      } else if (component.id === 'tech-stack') {
        component.hasOptions = true;
        component.selectedStacks = component.selectedStacks || [];
      } else {
        const presets = COMPONENT_PRESETS[component.id] || [];
        if (presets.length) {
          component.hasOptions = true;
          component.selectedPreset = resolvePresetSelection(component, presets);
        }
      }
    });
  }

  export function init(context) {
    console.log('AI Prompt Builder v3.0 initialized');

    // Load saved configuration and custom templates
    loadConfig();
    loadCustomTemplates();
    normalizeComponents();

    // Check for shared config in URL
    loadFromURL();

    // Render components and templates
    renderComponents();
    renderTemplates();
    updatePreview();

    // Event listeners
    setupEventListeners();
    setupDropZone();
    setupModals();
    setupCollapsibles();
  }

  export function cleanup(context) {
    console.log('AI Prompt Builder cleanup');
    saveConfig();
  }

  function setupEventListeners() {
    document.getElementById('add-component-btn').addEventListener('click', handleAddComponent);
    document.getElementById('new-component-name').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAddComponent();
    });

    document.getElementById('copy-prompt-btn').addEventListener('click', handleCopyPrompt);
    document.getElementById('save-prompt-btn').addEventListener('click', handleSavePrompt);
    document.getElementById('import-file-btn').addEventListener('click', handleImportProjectFile);
    document.getElementById('import-config-btn').addEventListener('click', handleImportConfig);
    document.getElementById('export-config-btn').addEventListener('click', handleExportConfig);
    document.getElementById('reset-config-btn').addEventListener('click', handleResetConfig);
    document.getElementById('share-btn').addEventListener('click', handleShare);

    // Export format change
    document.getElementById('export-format').addEventListener('change', updatePreview);

    // Placeholder management
    document.getElementById('fill-placeholders-btn').addEventListener('click', applyPlaceholders);
    document.getElementById('clear-placeholders-btn').addEventListener('click', clearPlaceholders);
    document.getElementById('placeholders-list').addEventListener('input', handlePlaceholderInput);

    // Template management
    document.getElementById('save-template-btn').addEventListener('click', showSaveTemplateModal);
    document.getElementById('save-template-confirm-btn').addEventListener('click', handleSaveCustomTemplate);
    document.getElementById('template-search').addEventListener('input', filterTemplates);
    document.getElementById('template-category').addEventListener('change', filterTemplates);
    document.getElementById('templates-grid').addEventListener('click', handleTemplateClick);

    // Share modal
    document.getElementById('copy-link-btn').addEventListener('click', copyShareLink);
    document.getElementById('download-qr-btn').addEventListener('click', downloadQRCode);

    // Component list delegation
    document.getElementById('components-list').addEventListener('click', handleComponentClick);
    document.getElementById('components-list').addEventListener('input', handleComponentInput);
    document.getElementById('components-list').addEventListener('change', handleComponentPresetChange);
  }

  function setupDropZone() {
    const dropZone = document.getElementById('drop-zone');

    dropZone.addEventListener('click', () => {
      document.getElementById('project-file-input').click();
    });

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');

      const file = e.dataTransfer.files[0];
      if (file) {
        processProjectFile(file);
      }
    });

    document.getElementById('project-file-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        processProjectFile(file);
      }
    });
  }

  function setupModals() {
    // Close modals on background click or close button
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.classList.contains('modal-close')) {
          closeModal();
        }
      });
    });

    // Tech stack search
    document.getElementById('techstack-search').addEventListener('input', (e) => {
      filterTechStacks(e.target.value);
    });
  }

  function processProjectFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const content = e.target.result;
        let techInfo = { technologies: [], description: '' };

        if (file.name === 'package.json') {
          techInfo = parsePackageJson(content);
        } else if (file.name === 'requirements.txt') {
          techInfo = parseRequirementsTxt(content);
        }

        if (techInfo.technologies.length > 0) {
          updateTechStackComponent(techInfo);
          showStatus(`Detected ${techInfo.technologies.length} technologies from ${file.name}`, 'success');
        } else {
          showStatus('No technologies detected in file', 'info');
        }
      } catch (error) {
        showStatus(`Error processing file: ${error.message}`, 'error');
      }
    };
    reader.readAsText(file);
  }

  function parsePackageJson(content) {
    const data = JSON.parse(content);
    const technologies = [];
    const deps = { ...data.dependencies, ...data.devDependencies };

    // Map common npm packages to technologies
    const techMap = {
      'react': 'React',
      'vue': 'Vue.js',
      'angular': 'Angular',
      '@angular/core': 'Angular',
      'svelte': 'Svelte',
      'next': 'Next.js',
      'nuxt': 'Nuxt.js',
      'express': 'Express.js',
      'typescript': 'TypeScript',
      'webpack': 'Webpack',
      'vite': 'Vite',
      'tailwindcss': 'Tailwind CSS',
      'bootstrap': 'Bootstrap',
      'jest': 'Jest',
      'vitest': 'Vitest',
      'cypress': 'Cypress',
      'playwright': 'Playwright'
    };

    Object.keys(deps).forEach(pkg => {
      const tech = techMap[pkg] || techMap[pkg.split('/').pop()];
      if (tech && !technologies.includes(tech)) {
        technologies.push(tech);
      }
    });

    // Add Node.js if package.json exists
    if (!technologies.includes('Node.js')) {
      technologies.unshift('Node.js');
    }

    return {
      technologies,
      description: data.description || ''
    };
  }

  function parseRequirementsTxt(content) {
    const technologies = ['Python'];
    const lines = content.split('\n');

    const techMap = {
      'django': 'Django',
      'flask': 'Flask',
      'fastapi': 'FastAPI',
      'pandas': 'Pandas',
      'numpy': 'NumPy',
      'tensorflow': 'TensorFlow',
      'pytorch': 'PyTorch',
      'scikit-learn': 'Scikit-learn',
      'requests': 'Python Requests',
      'sqlalchemy': 'SQLAlchemy'
    };

    lines.forEach(line => {
      const pkg = line.split('==')[0].split('>=')[0].trim().toLowerCase();
      const tech = techMap[pkg];
      if (tech && !technologies.includes(tech)) {
        technologies.push(tech);
      }
    });

    return { technologies, description: '' };
  }

  function updateTechStackComponent(techInfo) {
    const component = state.config.components.find(c => c.id === 'tech-stack');
    if (component) {
      component.selectedStacks = techInfo.technologies;
      const stackList = techInfo.technologies.join(', ');
      component.content = `Technology stack: ${stackList}\n\nPlease provide solutions and examples specific to these technologies.`;
      component.enabled = true;
      renderComponents();
      updatePreview();
      saveConfig();
    }
  }

  function showPersonaModal(componentId) {
    const modal = document.getElementById('persona-modal');
    const grid = document.getElementById('personas-grid');

    const component = state.config.components.find(c => c.id === componentId);
    const selectedPersona = component?.selectedPersona || 'senior-engineer';

    grid.innerHTML = PERSONAS.map(persona => `
      <div class="persona-card ${persona.id === selectedPersona ? 'selected' : ''}" data-persona="${persona.id}">
        <div class="persona-name">${persona.name}</div>
        <div class="persona-description">${persona.description}</div>
      </div>
    `).join('');

    grid.addEventListener('click', (e) => {
      const card = e.target.closest('.persona-card');
      if (card) {
        const personaId = card.dataset.persona;
        selectPersona(componentId, personaId);
        closeModal();
      }
    });

    state.currentModal = { type: 'persona', componentId };
    modal.classList.add('show');
  }

  function showTechStackModal(componentId) {
    const modal = document.getElementById('techstack-modal');
    const grid = document.getElementById('techstack-grid');

    const component = state.config.components.find(c => c.id === componentId);
    const selectedStacks = component?.selectedStacks || [];

    renderTechStackGrid(grid, selectedStacks);

    grid.addEventListener('click', (e) => {
      const item = e.target.closest('.techstack-item');
      if (item) {
        const tech = item.dataset.tech;
        toggleTechStack(componentId, tech);
      }
    });

    state.currentModal = { type: 'techstack', componentId };
    modal.classList.add('show');
  }

  function renderTechStackGrid(grid, selectedStacks, filter = '') {
    let html = '';

    Object.entries(TECH_STACKS).forEach(([category, technologies]) => {
      const filtered = technologies.filter(tech =>
        tech.toLowerCase().includes(filter.toLowerCase())
      );

      if (filtered.length > 0) {
        filtered.forEach(tech => {
          const selected = selectedStacks.includes(tech) ? 'selected' : '';
          html += `<div class="techstack-item ${selected}" data-tech="${tech}">${tech}</div>`;
        });
      }
    });

    grid.innerHTML = html || '<p style="text-align: center; color: var(--text-secondary);">No technologies found</p>';
  }

  function filterTechStacks(query) {
    const component = state.config.components.find(c => c.id === state.currentModal?.componentId);
    const selectedStacks = component?.selectedStacks || [];
    const grid = document.getElementById('techstack-grid');
    renderTechStackGrid(grid, selectedStacks, query);
  }

  function selectPersona(componentId, personaId) {
    const component = state.config.components.find(c => c.id === componentId);
    const persona = PERSONAS.find(p => p.id === personaId);

    if (component && persona) {
      component.selectedPersona = personaId;
      component.content = persona.content;
      renderComponents();
      updatePreview();
      saveConfig();
      showStatus(`Persona changed to: ${persona.name}`, 'success');
    }
  }

  function toggleTechStack(componentId, tech) {
    const component = state.config.components.find(c => c.id === componentId);
    if (!component) return;

    if (!component.selectedStacks) {
      component.selectedStacks = [];
    }

    const index = component.selectedStacks.indexOf(tech);
    if (index > -1) {
      component.selectedStacks.splice(index, 1);
    } else {
      component.selectedStacks.push(tech);
    }

    // Update content
    const stackList = component.selectedStacks.join(', ') || '{{tech_stack}}';
    component.content = `Technology stack: ${stackList}\n\nPlease provide solutions and examples specific to these technologies.`;

    // Re-render grid
    const grid = document.getElementById('techstack-grid');
    renderTechStackGrid(grid, component.selectedStacks);

    renderComponents();
    updatePreview();
    saveConfig();
  }

  function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.remove('show');
    });
    state.currentModal = null;
  }

  function renderComponents() {
    const list = document.getElementById('components-list');
    const components = state.config.components.sort((a, b) => a.order - b.order);

    list.innerHTML = components.map(comp => {
      let badge = '';
      if (comp.id === 'role' && comp.selectedPersona) {
        const persona = PERSONAS.find(p => p.id === comp.selectedPersona);
        badge = `<span class="component-badge">${persona?.name || 'Default'}</span>`;
      } else if (comp.id === 'tech-stack' && comp.selectedStacks?.length > 0) {
        badge = `<span class="component-badge">${comp.selectedStacks.length} selected</span>`;
      }

      const optionsHtml = renderComponentOptions(comp);
      const hasOptions = optionsHtml.trim().length > 0;

      return `
        <div class="component-item ${comp.enabled ? 'active' : ''} ${hasOptions ? 'has-options' : ''}" data-id="${comp.id}">
          <div class="component-header">
            <div class="component-toggle ${comp.enabled ? 'checked' : ''}" data-action="toggle"></div>
            <div class="component-name">${comp.name}</div>
            ${badge}
            <div class="component-actions">
              <button class="component-action" data-action="edit" title="Edit">??</button>
              <button class="component-action" data-action="move-up" title="Move Up"></button>
              <button class="component-action" data-action="move-down" title="Move Down"></button>
              <button class="component-action" data-action="delete" title="Delete">???</button>
            </div>
          </div>
          <div class="component-body">
            ${optionsHtml}
            <textarea data-id="${comp.id}" placeholder="Enter content for ${comp.name}...">${comp.content || ''}</textarea>
            <div class="component-meta">
              <span>${(comp.content || '').length} characters</span>
              <span>${(comp.content || '').split(/\s+/).filter(w => w).length} words</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderComponentOptions(comp) {
    const parts = [];

    if (comp.id === 'tech-stack') {
      parts.push('<button class="component-select-btn" data-action="select-techstack">?? Select Technologies</button>');
    }

    if (comp.id === 'role') {
      const selectedPersona = resolvePersonaSelection(comp);
      const personaOptions = PERSONAS.map(persona => `<option value="${persona.id}" ${persona.id === selectedPersona ? 'selected' : ''}>${persona.name}</option>`).join('');
      parts.push(`
        <div class="component-option-group">
          <label class="component-select-label">
            <span>Persona preset</span>
            <select class="component-preset-select" data-component-id="${comp.id}">
              <option value="custom" ${selectedPersona === 'custom' ? 'selected' : ''}>Custom persona</option>
              ${personaOptions}
            </select>
          </label>
          <button class="component-select-btn" data-action="select-persona">?? Persona Library</button>
        </div>
      `);
    }

    const presets = COMPONENT_PRESETS[comp.id] || [];
    if (presets.length && comp.id !== 'role') {
      const selectedPreset = resolvePresetSelection(comp, presets);
      const presetOptions = presets.map(p => `<option value="${p.id}" ${p.id === selectedPreset ? 'selected' : ''}>${p.name}</option>`).join('');
      parts.push(`
        <div class="component-option-group">
          <label class="component-select-label">
            <span>Select ${comp.name}</span>
            <select class="component-preset-select" data-component-id="${comp.id}">
              <option value="custom" ${selectedPreset === 'custom' ? 'selected' : ''}>Custom</option>
              ${presetOptions}
            </select>
          </label>
        </div>
      `);
    }

    return parts.join('');
  }

  function resolvePersonaSelection(component) {
    const personaExists = PERSONAS.some(p => p.id === component.selectedPersona);
    if (component.selectedPersona && personaExists) {
      return component.selectedPersona;
    }

    const match = PERSONAS.find(p => (p.content || '').trim() === (component.content || '').trim());
    if (match) {
      component.selectedPersona = match.id;
      return match.id;
    }

    return 'custom';
  }

  function resolvePresetSelection(component, presets) {
    if (!presets.length) {
      return 'custom';
    }

    if (component.selectedPreset && component.selectedPreset !== 'custom') {
      const exists = presets.some(p => p.id === component.selectedPreset);
      if (exists) {
        return component.selectedPreset;
      }
    }

    const normalizedContent = (component.content || '').trim();
    const match = presets.find(p => (p.content || '').trim() === normalizedContent);
    if (match) {
      component.selectedPreset = match.id;
      return match.id;
    }

    return 'custom';
  }
    return '';
  }

  function handleComponentClick(e) {
    const action = e.target.dataset.action;
    if (!action) return;

    const item = e.target.closest('.component-item');
    const id = item.dataset.id;
    const component = state.config.components.find(c => c.id === id);

    if (!component) return;

    switch (action) {
      case 'toggle':
        component.enabled = !component.enabled;
        renderComponents();
        updatePreview();
        saveConfig();
        break;

      case 'edit':
        item.classList.toggle('expanded');
        break;

      case 'select-persona':
        showPersonaModal(id);
        break;

      case 'select-techstack':
        showTechStackModal(id);
        break;

      case 'move-up':
        moveComponent(id, -1);
        break;

      case 'move-down':
        moveComponent(id, 1);
        break;

      case 'delete':
        if (confirm(`Delete component "${component.name}"?`)) {
          state.config.components = state.config.components.filter(c => c.id !== id);
          renderComponents();
          updatePreview();
          saveConfig();
          showStatus('Component deleted', 'info');
        }
        break;
    }
  }

  function handleComponentPresetChange(e) {
    const select = e.target.closest('.component-preset-select');
    if (!select) return;

    const componentId = select.dataset.componentId;
    const component = state.config.components.find(c => c.id === componentId);
    if (!component) return;

    if (componentId === 'role') {
      if (select.value === 'custom') {
        component.selectedPersona = 'custom';
        renderComponents();
        updatePreview();
        saveConfig();
        return;
      }
      selectPersona(componentId, select.value);
      return;
    }

    if (select.value === 'custom') {
      component.selectedPreset = 'custom';
      saveConfig();
      return;
    }

    const presets = COMPONENT_PRESETS[componentId] || [];
    const preset = presets.find(p => p.id === select.value);
    if (!preset) return;

    component.selectedPreset = preset.id;
    component.content = preset.content;
    renderComponents();
    updatePreview();
    saveConfig();
    showStatus(`${component.name} preset applied: ${preset.name}`, 'success');
  }

  function handleComponentInput(e) {
    if (e.target.tagName === 'TEXTAREA') {
      const id = e.target.dataset.id;
      const component = state.config.components.find(c => c.id === id);
      if (component) {
        component.content = e.target.value;

        if (component.id === 'role') {
          if (component.selectedPersona && component.selectedPersona !== 'custom') {
            const persona = PERSONAS.find(p => p.id === component.selectedPersona);
            if (!persona || persona.content !== component.content) {
              component.selectedPersona = 'custom';
              syncComponentPresetSelect(component.id, 'custom', e.target);
            }
          }
        } else {
          const presets = COMPONENT_PRESETS[component.id] || [];
          if (component.selectedPreset && component.selectedPreset !== 'custom') {
            const preset = presets.find(p => p.id === component.selectedPreset);
            if (!preset || preset.content !== component.content) {
              component.selectedPreset = 'custom';
              syncComponentPresetSelect(component.id, 'custom', e.target);
            }
          }
        }

        updatePreview();
        saveConfig();

        // Update meta info
        const meta = e.target.nextElementSibling;
        if (meta) {
          const chars = e.target.value.length;
          const words = e.target.value.split(/\s+/).filter(w => w).length;
          meta.innerHTML = `
            <span>${chars} characters</span>
            <span>${words} words</span>
          `;
        }
      }
    }
  }

  function syncComponentPresetSelect(componentId, value, inputElement) {
    const container = inputElement.closest('.component-item');
    if (!container) return;
    const select = container.querySelector(`.component-preset-select[data-component-id="${componentId}"]`);
    if (select) {
      select.value = value;
    }
  }

  function moveComponent(id, direction) {
    const index = state.config.components.findIndex(c => c.id === id);
    if (index === -1) return;

    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= state.config.components.length) return;

    // Swap
    [state.config.components[index], state.config.components[newIndex]] =
    [state.config.components[newIndex], state.config.components[index]];

    // Update orders
    state.config.components.forEach((comp, idx) => {
      comp.order = idx + 1;
    });

    renderComponents();
    updatePreview();
    saveConfig();
  }

  function handleAddComponent() {
    const input = document.getElementById('new-component-name');
    const name = input.value.trim();

    if (!name) {
      showStatus('Please enter a component name', 'error');
      return;
    }

    const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');

    if (state.config.components.find(c => c.id === id)) {
      showStatus('Component with this name already exists', 'error');
      return;
    }

    state.config.components.push({
      id,
      name,
      enabled: true,
      order: state.config.components.length + 1,
      content: ''
    });

    input.value = '';
    renderComponents();
    updatePreview();
    saveConfig();
    showStatus(`Component "${name}" added`, 'success');
  }

  function updatePreview() {
    const format = document.getElementById('export-format').value;
    const enabledComponents = state.config.components
      .filter(c => c.enabled && c.content)
      .sort((a, b) => a.order - b.order);

    let prompt = '';

    if (format === 'markdown') {
      prompt = enabledComponents
        .map(c => `# ${c.name}\n\n${c.content}`)
        .join('\n\n---\n\n');
    } else if (format === 'plain') {
      prompt = enabledComponents
        .map(c => `${c.name}:\n${c.content}`)
        .join('\n\n');
    } else {
      // Structured format (default)
      prompt = enabledComponents
        .map(c => {
          const separator = '='.repeat(c.name.length + 4);
          return `${separator}\n# ${c.name}\n${separator}\n\n${c.content}`;
        })
        .join('\n\n');
    }

    const textarea = document.getElementById('final-prompt');
    textarea.value = prompt;

    // Update stats
    const chars = prompt.length;
    const words = prompt.split(/\s+/).filter(w => w).length;
    const lines = prompt.split('\n').length;
    const placeholders = (prompt.match(/\{\{[^}]+\}\}/g) || []).length;

    document.getElementById('char-count').textContent = `${chars} characters`;
    document.getElementById('word-count').textContent = `${words} words`;
    document.getElementById('line-count').textContent = `${lines} lines`;
    document.getElementById('placeholder-count').textContent = `${placeholders} placeholders`;

    // Refresh placeholder panel whenever preview content changes
    updatePlaceholders();
  }

  function handleCopyPrompt() {
    const textarea = document.getElementById('final-prompt');
    textarea.select();
    document.execCommand('copy');
    showStatus('Prompt copied to clipboard!', 'success');
  }

  function handleSavePrompt() {
    const prompt = document.getElementById('final-prompt').value;
    if (!prompt) {
      showStatus('No prompt to save', 'error');
      return;
    }

    const format = document.getElementById('export-format').value;
    const extension = format === 'markdown' ? 'md' : 'txt';

    const blob = new Blob([prompt], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-prompt-${Date.now()}.${extension}`;
    a.click();
    URL.revokeObjectURL(url);
    showStatus('Prompt saved to file', 'success');
  }

  function handleImportProjectFile() {
    document.getElementById('project-file-input').click();
  }

  function handleImportConfig() {
    const input = document.getElementById('file-input');
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const config = JSON.parse(event.target.result);
          if (!config.components || !Array.isArray(config.components)) {
            throw new Error('Invalid configuration format');
          }
          state.config = config;
          normalizeComponents();
          renderComponents();
          updatePreview();
          saveConfig();
          showStatus('Configuration imported successfully', 'success');
        } catch (error) {
          showStatus(`Import failed: ${error.message}`, 'error');
        }
      };
      reader.readAsText(file);
      input.value = '';
    };
    input.click();
  }

  function handleExportConfig() {
    const json = JSON.stringify(state.config, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prompt-config-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showStatus('Configuration exported', 'success');
  }

  function handleResetConfig() {
    if (confirm('Reset to default configuration? This will discard all changes.')) {
      state.config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
      normalizeComponents();
      renderComponents();
      updatePreview();
      saveConfig();
      showStatus('Configuration reset to defaults', 'info');
    }
  }

  function loadTemplate(templateId) {
    const template = TEMPLATES[templateId];
    if (!template) return;

    if (confirm(`Load "${template.name}" template? This will replace your current configuration.`)) {
      state.config.components = JSON.parse(JSON.stringify(template.components));
      normalizeComponents();
      renderComponents();
      updatePreview();
      saveConfig();
      showStatus(`Template "${template.name}" loaded`, 'success');
    }
  }

  function saveConfig() {
    try {
      localStorage.setItem('ai-prompt-builder-config', JSON.stringify(state.config));
    } catch (error) {
      console.error('Failed to save config:', error);
    }
  }

  function loadConfig() {
    try {
      const saved = localStorage.getItem('ai-prompt-builder-config');
      if (saved) {
        state.config = JSON.parse(saved);
      }
    } catch (error) {
      console.error('Failed to load config:', error);
    }
  }

  function showStatus(message, type = 'info') {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    statusEl.className = `status-message show ${type}`;

    setTimeout(() => {
      statusEl.classList.remove('show');
    }, 3000);
  }

  // ============================================================
  // PLACEHOLDER MANAGEMENT
  // ============================================================

  function updatePlaceholders() {
    const placeholders = extractPlaceholders();
    renderPlaceholders(placeholders);
  }

  function extractPlaceholders() {
    const placeholderSet = new Set();
    const regex = /\{\{([^}]+)\}\}/g;

    state.config.components.forEach(comp => {
      if (comp.enabled && comp.content) {
        let match;
        while ((match = regex.exec(comp.content)) !== null) {
          placeholderSet.add(match[1].trim());
        }
      }
    });

    return Array.from(placeholderSet).sort();
  }

  function renderPlaceholders(placeholders) {
    const list = document.getElementById('placeholders-list');
    const badge = document.getElementById('placeholder-badge');

    badge.textContent = placeholders.length;

    if (placeholders.length === 0) {
      list.innerHTML = '<p class="empty-state">No placeholders found. Use {{placeholder}} syntax in your components.</p>';
      return;
    }

    list.innerHTML = placeholders.map(placeholder => {
      const value = state.placeholders[placeholder] || '';
      const filledClass = value ? 'filled' : '';
      return `
        <div class="placeholder-item">
          <div class="placeholder-name">{{${placeholder}}}</div>
          <input
            type="text"
            class="placeholder-input ${filledClass}"
            data-placeholder="${placeholder}"
            value="${value}"
            placeholder="Enter value..."
          />
        </div>
      `;
    }).join('');
  }

  function handlePlaceholderInput(e) {
    if (e.target.classList.contains('placeholder-input')) {
      const placeholder = e.target.dataset.placeholder;
      const value = e.target.value;
      state.placeholders[placeholder] = value;

      // Update filled class
      if (value) {
        e.target.classList.add('filled');
      } else {
        e.target.classList.remove('filled');
      }

      savePlaceholders();
    }
  }

  function applyPlaceholders() {
    let replacedCount = 0;

    state.config.components.forEach(comp => {
      if (comp.enabled && comp.content) {
        let newContent = comp.content;
        Object.keys(state.placeholders).forEach(placeholder => {
          const value = state.placeholders[placeholder];
          if (value) {
            const regex = new RegExp(`\\{\\{\\s*${placeholder}\\s*\\}\\}`, 'g');
            const matches = newContent.match(regex);
            if (matches) {
              replacedCount += matches.length;
              newContent = newContent.replace(regex, value);
            }
          }
        });
        comp.content = newContent;
      }
    });

    if (replacedCount > 0) {
      renderComponents();
      updatePreview();
      saveConfig();
      showStatus(`Replaced ${replacedCount} placeholder(s)`, 'success');
    } else {
      showStatus('No placeholders to replace', 'info');
    }
  }

  function clearPlaceholders() {
    state.placeholders = {};
    savePlaceholders();
    renderPlaceholders(extractPlaceholders());
    showStatus('Placeholder values cleared', 'info');
  }

  function savePlaceholders() {
    try {
      localStorage.setItem('ai-prompt-builder-placeholders', JSON.stringify(state.placeholders));
    } catch (error) {
      console.error('Failed to save placeholders:', error);
    }
  }

  function loadPlaceholders() {
    try {
      const saved = localStorage.getItem('ai-prompt-builder-placeholders');
      if (saved) {
        state.placeholders = JSON.parse(saved);
      }
    } catch (error) {
      console.error('Failed to load placeholders:', error);
    }
  }

  // ============================================================
  // TEMPLATE MANAGEMENT
  // ============================================================

  function renderTemplates() {
    const grid = document.getElementById('templates-grid');
    const allTemplates = { ...TEMPLATES };

    // Add custom templates
    state.customTemplates.forEach(template => {
      allTemplates[template.id] = template;
    });

    const filtered = filterTemplatesBySearch(allTemplates);

    grid.innerHTML = Object.entries(filtered).map(([id, template]) => {
      const isCustom = state.customTemplates.some(t => t.id === id);
      const customClass = isCustom ? 'custom-template' : '';
      const deleteBtn = isCustom ? `<button class="delete-template-btn" data-template="${id}">√ó</button>` : '';

      return `
        <button class="template-btn ${customClass}" data-template="${id}">
          ${template.name}
          ${deleteBtn}
        </button>
      `;
    }).join('');
  }

  function filterTemplatesBySearch(templates) {
    const search = document.getElementById('template-search').value.toLowerCase();
    const category = document.getElementById('template-category').value;

    return Object.fromEntries(
      Object.entries(templates).filter(([id, template]) => {
        const matchesSearch = !search || template.name.toLowerCase().includes(search);
        const matchesCategory = !category || template.category === category;
        return matchesSearch && matchesCategory;
      })
    );
  }

  function filterTemplates() {
    renderTemplates();
  }

  function handleTemplateClick(e) {
    const deleteBtn = e.target.closest('.delete-template-btn');
    if (deleteBtn) {
      e.stopPropagation();
      const templateId = deleteBtn.dataset.template;
      deleteCustomTemplate(templateId);
      return;
    }

    const templateBtn = e.target.closest('.template-btn');
    if (templateBtn) {
      const templateId = templateBtn.dataset.template;
      loadTemplate(templateId);
    }
  }

  function showSaveTemplateModal() {
    const modal = document.getElementById('save-template-modal');
    document.getElementById('template-name').value = '';
    document.getElementById('template-description').value = '';
    document.getElementById('template-category-select').value = 'custom';
    modal.classList.add('show');
  }

  function handleSaveCustomTemplate() {
    const name = document.getElementById('template-name').value.trim();
    const description = document.getElementById('template-description').value.trim();
    const category = document.getElementById('template-category-select').value;

    if (!name) {
      showStatus('Please enter a template name', 'error');
      return;
    }

    const id = 'custom-' + name.toLowerCase().replace(/[^a-z0-9]+/g, '-');

    // Check if template already exists
    if (state.customTemplates.some(t => t.id === id)) {
      if (!confirm('A template with this name already exists. Overwrite?')) {
        return;
      }
      state.customTemplates = state.customTemplates.filter(t => t.id !== id);
    }

    const template = {
      id,
      name,
      description,
      category,
      components: JSON.parse(JSON.stringify(state.config.components))
    };

    state.customTemplates.push(template);
    saveCustomTemplates();
    renderTemplates();
    closeModal();
    showStatus(`Template "${name}" saved`, 'success');
  }

  function deleteCustomTemplate(id) {
    const template = state.customTemplates.find(t => t.id === id);
    if (!template) return;

    if (confirm(`Delete template "${template.name}"?`)) {
      state.customTemplates = state.customTemplates.filter(t => t.id !== id);
      saveCustomTemplates();
      renderTemplates();
      showStatus(`Template "${template.name}" deleted`, 'info');
    }
  }

  function saveCustomTemplates() {
    try {
      localStorage.setItem('ai-prompt-builder-custom-templates', JSON.stringify(state.customTemplates));
    } catch (error) {
      console.error('Failed to save custom templates:', error);
    }
  }

  function loadCustomTemplates() {
    try {
      const saved = localStorage.getItem('ai-prompt-builder-custom-templates');
      if (saved) {
        state.customTemplates = JSON.parse(saved);
      }
    } catch (error) {
      console.error('Failed to load custom templates:', error);
    }
  }

  // ============================================================
  // SHARING & COLLABORATION
  // ============================================================

  function handleShare() {
    const modal = document.getElementById('share-modal');
    const link = generateShareLink();
    document.getElementById('share-link').value = link;
    generateQRCode(link);
    modal.classList.add('show');
  }

  function generateShareLink() {
    const config = {
      components: state.config.components,
      version: '3.0.0'
    };

    const json = JSON.stringify(config);
    const base64 = btoa(unescape(encodeURIComponent(json)));
    const url = window.location.href.split('#')[0] + '#share=' + base64;
    return url;
  }

  function copyShareLink() {
    const input = document.getElementById('share-link');
    input.select();
    document.execCommand('copy');
    showStatus('Share link copied to clipboard!', 'success');
  }

  function loadFromURL() {
    const hash = window.location.hash;
    if (hash.startsWith('#share=')) {
      try {
        const base64 = hash.substring(7);
        const json = decodeURIComponent(escape(atob(base64)));
        const config = JSON.parse(json);

        if (config.components && Array.isArray(config.components)) {
          if (confirm('Load shared configuration? This will replace your current configuration.')) {
            state.config.components = config.components;
            normalizeComponents();
            renderComponents();
            updatePreview();
            saveConfig();
            showStatus('Configuration loaded from shared link', 'success');
            window.location.hash = '';
          }
        }
      } catch (error) {
        console.error('Failed to load from URL:', error);
        showStatus('Invalid share link', 'error');
      }
    }
  }

  function generateQRCode(text) {
    const canvas = document.getElementById('qr-canvas');
    const ctx = canvas.getContext('2d');
    const size = 200;

    // Simple QR code generation (you can use a library for real implementation)
    // For now, we'll create a simple text representation
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, size, size);

    ctx.fillStyle = '#000000';
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // Draw a simple pattern representing QR code
    const moduleSize = 4;
    const modules = Math.floor(size / moduleSize);

    // Create a simple deterministic pattern from the text
    for (let y = 0; y < modules; y++) {
      for (let x = 0; x < modules; x++) {
        const index = (y * modules + x) % text.length;
        const charCode = text.charCodeAt(index);
        if ((charCode + x + y) % 2 === 0) {
          ctx.fillRect(x * moduleSize, y * moduleSize, moduleSize, moduleSize);
        }
      }
    }

    // Add "QR Code" label
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(size/2 - 40, size/2 - 10, 80, 20);
    ctx.fillStyle = '#000000';
    ctx.font = '12px sans-serif';
    ctx.fillText('Scan to Import', size/2, size/2);
  }

  function downloadQRCode() {
    const canvas = document.getElementById('qr-canvas');
    const link = document.createElement('a');
    link.download = 'ai-prompt-builder-qr.png';
    link.href = canvas.toDataURL();
    link.click();
    showStatus('QR code downloaded', 'success');
  }

  // ============================================================
  // COLLAPSIBLE SECTIONS
  // ============================================================

  function setupCollapsibles() {
    const headers = document.querySelectorAll('.section-header.collapsible');
    headers.forEach(header => {
      header.addEventListener('click', (e) => {
        // Don't toggle if clicking on a button inside the header
        if (e.target.closest('button:not(.collapse-btn)')) {
          return;
        }

        header.classList.toggle('collapsed');
        const content = header.nextElementSibling;
        if (content) {
          if (header.classList.contains('collapsed')) {
            content.style.maxHeight = '0';
          } else {
            content.style.maxHeight = content.scrollHeight + 'px';
          }
        }
      });

      // Set initial max-height for non-collapsed sections
      if (!header.classList.contains('collapsed')) {
        const content = header.nextElementSibling;
        if (content) {
          content.style.maxHeight = content.scrollHeight + 'px';
        }
      }
    });
  }

  // Load placeholders on init
  loadPlaceholders();
</script>

</body>
</html>

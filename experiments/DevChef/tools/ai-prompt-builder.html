<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Prompt Builder - DevChef Tool</title>
</head>
<body>

<!-- DevChef Manifest -->
<script type="devchef-manifest">
{
  "id": "ai-prompt-builder",
  "name": "AI Prompt Builder",
  "category": "Developer Tools",
  "description": "Compose AI prompts from configurable components - role, context, input, rules, output format",
  "keywords": ["ai", "prompt", "llm", "chatgpt", "claude", "composer"],
  "version": "1.0.0"
}
</script>

<!-- Tool UI Template -->
<template id="tool-ui">
  <div class="tool-container">
    <div class="tool-header">
      <h2 class="tool-title">AI Prompt Builder</h2>
      <p class="tool-description">Compose structured prompts from configurable components</p>
    </div>

    <div class="tool-layout">
      <!-- Left Panel: Components -->
      <div class="components-panel">
        <div class="panel-header">
          <h3>Prompt Components</h3>
          <div class="panel-actions">
            <button id="import-config-btn" class="icon-btn" title="Import Configuration">üì•</button>
            <button id="export-config-btn" class="icon-btn" title="Export Configuration">üì§</button>
            <button id="reset-config-btn" class="icon-btn" title="Reset to Default">üîÑ</button>
          </div>
        </div>

        <div id="components-list" class="components-list">
          <!-- Components will be rendered here -->
        </div>

        <div class="add-component-section">
          <input type="text" id="new-component-name" placeholder="New component name..." />
          <button id="add-component-btn">+ Add Component</button>
        </div>
      </div>

      <!-- Right Panel: Preview & Export -->
      <div class="preview-panel">
        <div class="panel-header">
          <h3>Final Prompt</h3>
          <div class="panel-actions">
            <button id="copy-prompt-btn" class="primary">üìã Copy</button>
            <button id="save-prompt-btn" class="secondary">üíæ Save</button>
          </div>
        </div>

        <div class="preview-area">
          <textarea id="final-prompt" readonly placeholder="Your composed prompt will appear here..."></textarea>
        </div>

        <div class="stats-bar">
          <span id="char-count">0 characters</span>
          <span id="word-count">0 words</span>
          <span id="line-count">0 lines</span>
        </div>

        <div class="templates-section">
          <label class="section-label">Quick Templates</label>
          <div class="templates-grid">
            <button class="template-btn" data-template="code-review">Code Review</button>
            <button class="template-btn" data-template="data-analysis">Data Analysis</button>
            <button class="template-btn" data-template="content-writer">Content Writer</button>
            <button class="template-btn" data-template="tech-explainer">Tech Explainer</button>
            <button class="template-btn" data-template="custom">Custom</button>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="file-input" accept=".json" style="display: none;">
    <div id="status-message" class="status-message"></div>
  </div>
</template>

<!-- Tool Styles -->
<style>
  .tool-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }

  .components-panel,
  .preview-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 250px);
  }

  .panel-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-primary);
  }

  .panel-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .panel-actions {
    display: flex;
    gap: 8px;
  }

  .icon-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .icon-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--primary-color);
  }

  .components-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
  }

  .component-item {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 12px;
    overflow: hidden;
    transition: all 0.2s;
  }

  .component-item.active {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 1px var(--primary-color);
  }

  .component-header {
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg-secondary);
    cursor: pointer;
    user-select: none;
  }

  .component-header:hover {
    background: var(--bg-hover);
  }

  .component-toggle {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border-color);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .component-toggle.checked {
    background: var(--primary-color);
    border-color: var(--primary-color);
  }

  .component-toggle.checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
  }

  .component-name {
    flex: 1;
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
  }

  .component-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .component-header:hover .component-actions {
    opacity: 1;
  }

  .component-action {
    background: transparent;
    border: none;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
    border-radius: 3px;
    transition: background 0.2s;
  }

  .component-action:hover {
    background: var(--bg-primary);
  }

  .component-body {
    padding: 12px;
    display: none;
  }

  .component-item.expanded .component-body {
    display: block;
  }

  .component-body textarea {
    width: 100%;
    min-height: 100px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 13px;
    resize: vertical;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .component-body textarea:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .component-meta {
    display: flex;
    gap: 12px;
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .add-component-section {
    padding: 12px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 8px;
  }

  #new-component-name {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  #new-component-name:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  #add-component-btn {
    padding: 8px 16px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.2s;
  }

  #add-component-btn:hover {
    background: var(--primary-hover);
  }

  .preview-area {
    flex: 1;
    padding: 16px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  #final-prompt {
    flex: 1;
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.6;
    resize: none;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  #final-prompt:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .stats-bar {
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 24px;
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--bg-primary);
  }

  .templates-section {
    padding: 16px;
    border-top: 1px solid var(--border-color);
  }

  .templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
    margin-top: 12px;
  }

  .template-btn {
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    color: var(--text-primary);
  }

  .template-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }

  .status-message {
    margin-top: 16px;
    padding: 12px;
    border-radius: 4px;
    font-size: 13px;
    display: none;
  }

  .status-message.show {
    display: block;
  }

  .status-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .status-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .status-message.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }

  @media (max-width: 1024px) {
    .tool-layout {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Tool Module -->
<script type="module">
  // Default configuration with common prompt components
  const DEFAULT_CONFIG = {
    components: [
      {
        id: 'role',
        name: 'Role / Persona',
        enabled: true,
        order: 1,
        content: 'You are an expert software engineer with deep knowledge of modern development practices, design patterns, and clean code principles.'
      },
      {
        id: 'context',
        name: 'Context',
        enabled: true,
        order: 2,
        content: 'The user is working on a TypeScript project using React and needs assistance with component architecture and state management.'
      },
      {
        id: 'task',
        name: 'Task / Input',
        enabled: true,
        order: 3,
        content: '[DESCRIBE YOUR SPECIFIC TASK OR QUESTION HERE]'
      },
      {
        id: 'rules',
        name: 'Processing Rules',
        enabled: true,
        order: 4,
        content: `Rules to follow:
- Provide clear, concise explanations
- Include code examples when relevant
- Explain your reasoning
- Consider edge cases and error handling
- Follow industry best practices`
      },
      {
        id: 'output-format',
        name: 'Output Format',
        enabled: true,
        order: 5,
        content: `Format your response as:
1. Brief summary
2. Detailed explanation
3. Code example (if applicable)
4. Testing considerations`
      },
      {
        id: 'company',
        name: 'Company Info',
        enabled: false,
        order: 6,
        content: 'Company: [Your Company Name]\nIndustry: [Industry]\nTech Stack: [Technologies]'
      },
      {
        id: 'personal',
        name: 'Personal Preferences',
        enabled: false,
        order: 7,
        content: 'Preferences:\n- Code style: [e.g., functional, OOP]\n- Verbosity: [concise/detailed]\n- Examples: [always/when needed]'
      },
      {
        id: 'constraints',
        name: 'Constraints',
        enabled: false,
        order: 8,
        content: 'Constraints:\n- Must be compatible with Node.js 18+\n- No external dependencies\n- Performance-critical'
      }
    ]
  };

  // Predefined templates
  const TEMPLATES = {
    'code-review': {
      name: 'Code Review Assistant',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          content: 'You are a senior code reviewer with expertise in software architecture, security, and performance optimization.'
        },
        {
          id: 'task',
          name: 'Task / Input',
          enabled: true,
          order: 2,
          content: '[PASTE CODE TO REVIEW HERE]'
        },
        {
          id: 'rules',
          name: 'Review Criteria',
          enabled: true,
          order: 3,
          content: `Review the code for:
- Code quality and readability
- Performance issues
- Security vulnerabilities
- Best practices adherence
- Potential bugs
- Maintainability concerns`
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Structure your review as:
1. Overall assessment (1-2 sentences)
2. Critical issues (must fix)
3. Suggestions (should fix)
4. Nitpicks (optional improvements)
5. Positive highlights`
        }
      ]
    },
    'data-analysis': {
      name: 'Data Analysis Assistant',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          content: 'You are a data analyst with expertise in statistical analysis, data visualization, and insight extraction.'
        },
        {
          id: 'context',
          name: 'Context',
          enabled: true,
          order: 2,
          content: 'Dataset description:\n- Source: [data source]\n- Size: [number of records]\n- Fields: [list key fields]'
        },
        {
          id: 'task',
          name: 'Analysis Task',
          enabled: true,
          order: 3,
          content: '[DESCRIBE WHAT YOU WANT TO ANALYZE OR DISCOVER]'
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Provide:
1. Key findings (bullet points)
2. Statistical summary
3. Visualization recommendations
4. Actionable insights
5. Next steps for deeper analysis`
        }
      ]
    },
    'content-writer': {
      name: 'Content Writer',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          content: 'You are a professional content writer with expertise in technical writing, copywriting, and storytelling.'
        },
        {
          id: 'task',
          name: 'Writing Task',
          enabled: true,
          order: 2,
          content: 'Topic: [YOUR TOPIC]\nTarget Audience: [AUDIENCE]\nTone: [professional/casual/technical]'
        },
        {
          id: 'rules',
          name: 'Writing Guidelines',
          enabled: true,
          order: 3,
          content: `Guidelines:
- Clear and engaging language
- Active voice preferred
- Include examples where relevant
- Break up text with subheadings
- Conclude with key takeaways`
        },
        {
          id: 'constraints',
          name: 'Constraints',
          enabled: true,
          order: 4,
          content: 'Length: [word count]\nSEO keywords: [keywords]\nStyle: [blog/documentation/marketing]'
        }
      ]
    },
    'tech-explainer': {
      name: 'Technical Explainer',
      components: [
        {
          id: 'role',
          name: 'Role / Persona',
          enabled: true,
          order: 1,
          content: 'You are a technical educator who excels at explaining complex technical concepts in simple, understandable terms.'
        },
        {
          id: 'task',
          name: 'Concept to Explain',
          enabled: true,
          order: 2,
          content: '[TECHNICAL CONCEPT OR TECHNOLOGY TO EXPLAIN]'
        },
        {
          id: 'rules',
          name: 'Explanation Rules',
          enabled: true,
          order: 3,
          content: `Follow these principles:
- Start with a simple analogy
- Build from basics to advanced
- Use concrete examples
- Avoid unnecessary jargon
- Include practical applications`
        },
        {
          id: 'output-format',
          name: 'Output Format',
          enabled: true,
          order: 4,
          content: `Structure:
1. Simple analogy (ELI5)
2. Core concept explanation
3. How it works (step-by-step)
4. Real-world examples
5. Common misconceptions
6. Further learning resources`
        }
      ]
    },
    'custom': {
      name: 'Custom Template',
      components: DEFAULT_CONFIG.components
    }
  };

  let state = {
    config: JSON.parse(JSON.stringify(DEFAULT_CONFIG))
  };

  export function init(context) {
    console.log('AI Prompt Builder initialized');

    // Load saved configuration
    loadConfig();

    // Render components
    renderComponents();
    updatePreview();

    // Event listeners
    document.getElementById('add-component-btn').addEventListener('click', handleAddComponent);
    document.getElementById('new-component-name').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAddComponent();
    });

    document.getElementById('copy-prompt-btn').addEventListener('click', handleCopyPrompt);
    document.getElementById('save-prompt-btn').addEventListener('click', handleSavePrompt);
    document.getElementById('import-config-btn').addEventListener('click', handleImportConfig);
    document.getElementById('export-config-btn').addEventListener('click', handleExportConfig);
    document.getElementById('reset-config-btn').addEventListener('click', handleResetConfig);

    // Template buttons
    document.querySelectorAll('.template-btn').forEach(btn => {
      btn.addEventListener('click', () => loadTemplate(btn.dataset.template));
    });

    // Component list delegation
    document.getElementById('components-list').addEventListener('click', handleComponentClick);
    document.getElementById('components-list').addEventListener('input', handleComponentInput);
  }

  export function cleanup(context) {
    console.log('AI Prompt Builder cleanup');
    saveConfig();
  }

  function renderComponents() {
    const list = document.getElementById('components-list');
    const components = state.config.components.sort((a, b) => a.order - b.order);

    list.innerHTML = components.map(comp => `
      <div class="component-item ${comp.enabled ? 'active' : ''}" data-id="${comp.id}">
        <div class="component-header">
          <div class="component-toggle ${comp.enabled ? 'checked' : ''}" data-action="toggle"></div>
          <div class="component-name">${comp.name}</div>
          <div class="component-actions">
            <button class="component-action" data-action="edit" title="Edit">‚úèÔ∏è</button>
            <button class="component-action" data-action="move-up" title="Move Up">‚Üë</button>
            <button class="component-action" data-action="move-down" title="Move Down">‚Üì</button>
            <button class="component-action" data-action="delete" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
        <div class="component-body">
          <textarea data-id="${comp.id}" placeholder="Enter content for ${comp.name}...">${comp.content || ''}</textarea>
          <div class="component-meta">
            <span>${(comp.content || '').length} characters</span>
            <span>${(comp.content || '').split(/\s+/).filter(w => w).length} words</span>
          </div>
        </div>
      </div>
    `).join('');
  }

  function handleComponentClick(e) {
    const action = e.target.dataset.action;
    if (!action) return;

    const item = e.target.closest('.component-item');
    const id = item.dataset.id;
    const component = state.config.components.find(c => c.id === id);

    if (!component) return;

    switch (action) {
      case 'toggle':
        component.enabled = !component.enabled;
        renderComponents();
        updatePreview();
        saveConfig();
        break;

      case 'edit':
        item.classList.toggle('expanded');
        break;

      case 'move-up':
        moveComponent(id, -1);
        break;

      case 'move-down':
        moveComponent(id, 1);
        break;

      case 'delete':
        if (confirm(`Delete component "${component.name}"?`)) {
          state.config.components = state.config.components.filter(c => c.id !== id);
          renderComponents();
          updatePreview();
          saveConfig();
          showStatus('Component deleted', 'info');
        }
        break;
    }
  }

  function handleComponentInput(e) {
    if (e.target.tagName === 'TEXTAREA') {
      const id = e.target.dataset.id;
      const component = state.config.components.find(c => c.id === id);
      if (component) {
        component.content = e.target.value;
        updatePreview();
        saveConfig();

        // Update meta info
        const meta = e.target.nextElementSibling;
        if (meta) {
          const chars = e.target.value.length;
          const words = e.target.value.split(/\s+/).filter(w => w).length;
          meta.innerHTML = `
            <span>${chars} characters</span>
            <span>${words} words</span>
          `;
        }
      }
    }
  }

  function moveComponent(id, direction) {
    const index = state.config.components.findIndex(c => c.id === id);
    if (index === -1) return;

    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= state.config.components.length) return;

    // Swap
    [state.config.components[index], state.config.components[newIndex]] =
    [state.config.components[newIndex], state.config.components[index]];

    // Update orders
    state.config.components.forEach((comp, idx) => {
      comp.order = idx + 1;
    });

    renderComponents();
    updatePreview();
    saveConfig();
  }

  function handleAddComponent() {
    const input = document.getElementById('new-component-name');
    const name = input.value.trim();

    if (!name) {
      showStatus('Please enter a component name', 'error');
      return;
    }

    const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');

    if (state.config.components.find(c => c.id === id)) {
      showStatus('Component with this name already exists', 'error');
      return;
    }

    state.config.components.push({
      id,
      name,
      enabled: true,
      order: state.config.components.length + 1,
      content: ''
    });

    input.value = '';
    renderComponents();
    updatePreview();
    saveConfig();
    showStatus(`Component "${name}" added`, 'success');
  }

  function updatePreview() {
    const enabledComponents = state.config.components
      .filter(c => c.enabled && c.content)
      .sort((a, b) => a.order - b.order);

    const prompt = enabledComponents
      .map(c => {
        const separator = '='.repeat(c.name.length + 4);
        return `${separator}\n# ${c.name}\n${separator}\n\n${c.content}`;
      })
      .join('\n\n');

    const textarea = document.getElementById('final-prompt');
    textarea.value = prompt;

    // Update stats
    const chars = prompt.length;
    const words = prompt.split(/\s+/).filter(w => w).length;
    const lines = prompt.split('\n').length;

    document.getElementById('char-count').textContent = `${chars} characters`;
    document.getElementById('word-count').textContent = `${words} words`;
    document.getElementById('line-count').textContent = `${lines} lines`;
  }

  function handleCopyPrompt() {
    const textarea = document.getElementById('final-prompt');
    textarea.select();
    document.execCommand('copy');
    showStatus('Prompt copied to clipboard!', 'success');
  }

  function handleSavePrompt() {
    const prompt = document.getElementById('final-prompt').value;
    if (!prompt) {
      showStatus('No prompt to save', 'error');
      return;
    }

    const blob = new Blob([prompt], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prompt-${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    showStatus('Prompt saved to file', 'success');
  }

  function handleImportConfig() {
    const input = document.getElementById('file-input');
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const config = JSON.parse(event.target.result);
          if (!config.components || !Array.isArray(config.components)) {
            throw new Error('Invalid configuration format');
          }
          state.config = config;
          renderComponents();
          updatePreview();
          saveConfig();
          showStatus('Configuration imported successfully', 'success');
        } catch (error) {
          showStatus(`Import failed: ${error.message}`, 'error');
        }
      };
      reader.readAsText(file);
      input.value = '';
    };
    input.click();
  }

  function handleExportConfig() {
    const json = JSON.stringify(state.config, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prompt-config-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showStatus('Configuration exported', 'success');
  }

  function handleResetConfig() {
    if (confirm('Reset to default configuration? This will discard all changes.')) {
      state.config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
      renderComponents();
      updatePreview();
      saveConfig();
      showStatus('Configuration reset to defaults', 'info');
    }
  }

  function loadTemplate(templateId) {
    const template = TEMPLATES[templateId];
    if (!template) return;

    if (confirm(`Load "${template.name}" template? This will replace your current configuration.`)) {
      state.config.components = JSON.parse(JSON.stringify(template.components));
      renderComponents();
      updatePreview();
      saveConfig();
      showStatus(`Template "${template.name}" loaded`, 'success');
    }
  }

  function saveConfig() {
    try {
      localStorage.setItem('ai-prompt-builder-config', JSON.stringify(state.config));
    } catch (error) {
      console.error('Failed to save config:', error);
    }
  }

  function loadConfig() {
    try {
      const saved = localStorage.getItem('ai-prompt-builder-config');
      if (saved) {
        state.config = JSON.parse(saved);
      }
    } catch (error) {
      console.error('Failed to load config:', error);
    }
  }

  function showStatus(message, type = 'info') {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    statusEl.className = `status-message show ${type}`;

    setTimeout(() => {
      statusEl.classList.remove('show');
    }, 3000);
  }
</script>

</body>
</html>

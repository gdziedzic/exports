<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL Join Helper - DevChef Tool</title>
</head>
<body>

<!-- DevChef Manifest -->
<script type="devchef-manifest">
{
  "id": "sql-join-helper",
  "name": "SQL Join Helper",
  "category": "Database",
  "description": "Visual SQL JOIN builder with relationship mapping",
  "version": "1.0.0"
}
</script>

<!-- Tool UI Template -->
<template id="tool-ui">
  <div class="tool-container">
    <div class="tool-header">
      <h2 class="tool-title">SQL JOIN Helper</h2>
      <p class="tool-description">Build complex JOIN queries with visual relationship mapping</p>
    </div>

    <div class="tool-section">
      <label class="section-label">Load from JSON Schema</label>
      <textarea id="json-schema-input" placeholder='Paste JSON schema here (format: {"tables": [{"name": "Users", "schema": "dbo", "columns": [...]}, ...]})'></textarea>
      <button id="load-schema-btn" class="secondary">Load from JSON Schema</button>
    </div>

    <div class="tool-section">
      <label class="section-label">Tables</label>
      <div id="tables-list" class="tables-list"></div>
      <button id="add-table-btn" class="secondary">+ Add Table</button>
    </div>

    <div class="tool-section">
      <label class="section-label">Joins</label>
      <div id="joins-list" class="joins-list"></div>
      <button id="add-join-btn" class="secondary">+ Add JOIN</button>
    </div>

    <div class="tool-section">
      <label class="section-label">Query Options</label>
      <div class="query-options">
        <label>
          <span>SELECT columns:</span>
          <select id="select-mode">
            <option value="all">All columns (*)</option>
            <option value="table-prefix">Table.* for each table</option>
            <option value="explicit">Explicit columns</option>
          </select>
        </label>
        <div id="explicit-columns" style="display: none;">
          <textarea id="column-list" placeholder="table1.col1, table2.col2, ..."></textarea>
        </div>
      </div>
    </div>

    <div class="tool-section">
      <button id="generate-btn">Generate SQL</button>
      <button id="copy-btn" class="secondary">Copy SQL</button>
      <button id="reset-btn" class="secondary">Reset</button>
    </div>

    <div class="tool-section">
      <label class="section-label" for="output">Generated SQL Query</label>
      <textarea id="output" readonly></textarea>
    </div>

    <div class="tool-section">
      <label class="section-label">JOIN Types Reference</label>
      <div class="join-types-reference">
        <div class="join-type-card">
          <h4>INNER JOIN</h4>
          <p>Returns rows when there is a match in both tables</p>
          <div class="join-diagram">A ∩ B</div>
        </div>
        <div class="join-type-card">
          <h4>LEFT JOIN</h4>
          <p>Returns all rows from left table, matched rows from right</p>
          <div class="join-diagram">A ∪ (A ∩ B)</div>
        </div>
        <div class="join-type-card">
          <h4>RIGHT JOIN</h4>
          <p>Returns all rows from right table, matched rows from left</p>
          <div class="join-diagram">(A ∩ B) ∪ B</div>
        </div>
        <div class="join-type-card">
          <h4>FULL OUTER JOIN</h4>
          <p>Returns all rows when there is a match in either table</p>
          <div class="join-diagram">A ∪ B</div>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Tool Styles -->
<style>
  .tables-list, .joins-list {
    display: grid;
    gap: 12px;
    margin-bottom: 16px;
  }

  .table-row {
    display: grid;
    grid-template-columns: 1fr 2fr auto;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
    align-items: center;
  }

  .table-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .table-field label {
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .table-field input {
    padding: 8px;
    font-size: 13px;
  }

  .remove-btn {
    padding: 8px 12px;
    margin: 0;
    background: var(--error);
    color: white;
    font-size: 12px;
  }

  .join-row {
    display: grid;
    grid-template-columns: 1.5fr 1fr 1.5fr 1.5fr 1.5fr auto;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
    align-items: end;
  }

  .join-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .join-field label {
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .join-field select,
  .join-field input {
    padding: 8px;
    font-size: 13px;
  }

  .query-options {
    display: grid;
    gap: 12px;
  }

  .query-options label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }

  .query-options select {
    flex: 1;
    max-width: 300px;
  }

  #column-list {
    min-height: 80px;
    margin-top: 8px;
  }

  #json-schema-input {
    min-height: 120px;
    font-family: var(--font-mono);
    font-size: 13px;
    margin-bottom: 8px;
  }

  #output {
    min-height: 300px;
    font-family: var(--font-mono);
    font-size: 13px;
  }

  .join-types-reference {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
  }

  .join-type-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
  }

  .join-type-card h4 {
    margin: 0 0 8px 0;
    color: var(--accent);
    font-size: 14px;
  }

  .join-type-card p {
    margin: 0 0 12px 0;
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .join-diagram {
    padding: 12px;
    background: var(--bg-primary);
    border-radius: 4px;
    text-align: center;
    font-family: var(--font-mono);
    font-size: 16px;
    color: var(--accent);
  }

  @media (max-width: 768px) {
    .table-row, .join-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Standalone Styles -->
<style id="standalone-styles">
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e0e0e0;
    --border-color: #d0d0d0;
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --accent: #3498db;
    --accent-hover: #2980b9;
    --error: #e74c3c;
    --font-mono: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 24px;
    line-height: 1.6;
  }

  .tool-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .tool-header {
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border-color);
  }

  .tool-title {
    font-size: 32px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .tool-description {
    font-size: 16px;
    color: var(--text-secondary);
  }

  .tool-section {
    margin-bottom: 24px;
  }

  .section-label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input, select, textarea {
    width: 100%;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px;
    font-family: var(--font-sans);
    font-size: 14px;
    border-radius: 6px;
    transition: all 0.2s;
  }

  textarea {
    min-height: 100px;
    resize: vertical;
    font-family: var(--font-mono);
  }

  button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--font-sans);
    margin-right: 8px;
  }

  button:hover {
    background: var(--accent-hover);
  }

  button.secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  button.secondary:hover {
    background: var(--border-color);
  }
</style>

<!-- Tool Module Logic -->
<script type="module">
export const DevChefTool = {
  container: null,
  context: null,
  tables: [],
  joins: [],
  schemaData: null,

  init(container, context) {
    this.container = container;
    this.context = context;

    const generateBtn = container.querySelector("#generate-btn");
    const copyBtn = container.querySelector("#copy-btn");
    const resetBtn = container.querySelector("#reset-btn");
    const addTableBtn = container.querySelector("#add-table-btn");
    const addJoinBtn = container.querySelector("#add-join-btn");
    const selectMode = container.querySelector("#select-mode");
    const loadSchemaBtn = container.querySelector("#load-schema-btn");

    generateBtn?.addEventListener("click", () => this.generateSQL());
    copyBtn?.addEventListener("click", () => this.copyOutput());
    resetBtn?.addEventListener("click", () => this.reset());
    addTableBtn?.addEventListener("click", () => this.addTable());
    addJoinBtn?.addEventListener("click", () => this.addJoin());
    loadSchemaBtn?.addEventListener("click", () => this.loadFromJsonSchema());

    selectMode?.addEventListener("change", (e) => {
      const explicitColumns = container.querySelector("#explicit-columns");
      explicitColumns.style.display = e.target.value === 'explicit' ? 'block' : 'none';
    });

    // Add initial tables
    this.addTable('Users', 'u');
    this.addTable('Orders', 'o');
    this.addJoin();
  },

  loadFromJsonSchema() {
    const jsonSchemaInput = this.container.querySelector("#json-schema-input");
    const json = jsonSchemaInput?.value || '';

    if (!json.trim()) {
      alert('Please paste a JSON schema');
      return;
    }

    try {
      this.schemaData = JSON.parse(json);

      if (!this.schemaData.tables || !Array.isArray(this.schemaData.tables)) {
        alert('Invalid schema format. Expected: {"tables": [...]}');
        return;
      }

      if (this.schemaData.tables.length === 0) {
        alert('No tables found in schema');
        return;
      }

      // Clear existing tables and joins
      this.tables = [];
      this.joins = [];

      // Load all tables from schema
      this.schemaData.tables.forEach((table, index) => {
        const alias = this.generateAlias(table.name, index);
        this.addTable(table.name, alias, table.schema || 'dbo', table.columns);
      });

      // Add one join to get started
      if (this.tables.length > 1) {
        this.addJoin();
      }

      alert(`Successfully loaded ${this.schemaData.tables.length} table(s) from schema!`);

    } catch (error) {
      alert(`Error parsing JSON: ${error.message}`);
      console.error(error);
    }
  },

  generateAlias(tableName, index) {
    // Generate short alias from table name
    const words = tableName.match(/[A-Z][a-z]*/g) || [tableName];
    if (words.length > 1) {
      return words.map(w => w[0].toLowerCase()).join('');
    }
    return tableName.substring(0, 1).toLowerCase();
  },

  addTable(name = '', alias = '', schema = 'dbo', columns = []) {
    const table = { name, alias, schema, columns };
    this.tables.push(table);
    this.renderTables();
  },

  renderTables() {
    const tablesList = this.container.querySelector("#tables-list");
    if (!tablesList) return;

    tablesList.innerHTML = this.tables.map((table, index) => {
      const displayName = table.schema ? `${table.schema}.${table.name}` : table.name;
      const columnCount = table.columns ? ` (${table.columns.length} columns)` : '';
      return `
      <div class="table-row">
        <div class="table-field">
          <label>Table Name${columnCount}</label>
          <input type="text" class="table-name" data-index="${index}" value="${table.name}" placeholder="TableName">
        </div>
        <div class="table-field">
          <label>Alias</label>
          <input type="text" class="table-alias" data-index="${index}" value="${table.alias}" placeholder="t">
        </div>
        <button class="remove-btn remove-table" data-index="${index}">Remove</button>
      </div>
    `;
    }).join('');

    // Attach event listeners
    tablesList.querySelectorAll('.table-name').forEach(input => {
      input.addEventListener('input', (e) => {
        this.tables[e.target.dataset.index].name = e.target.value;
        this.updateJoinSelects();
      });
    });

    tablesList.querySelectorAll('.table-alias').forEach(input => {
      input.addEventListener('input', (e) => {
        this.tables[e.target.dataset.index].alias = e.target.value;
      });
    });

    tablesList.querySelectorAll('.remove-table').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.removeTable(parseInt(e.target.dataset.index));
      });
    });

    this.updateJoinSelects();
  },

  removeTable(index) {
    this.tables.splice(index, 1);
    this.renderTables();
  },

  addJoin(leftTable = '', leftColumn = '', rightTable = '', rightColumn = '', joinType = 'INNER JOIN') {
    const join = { leftTable, leftColumn, rightTable, rightColumn, joinType };
    this.joins.push(join);
    this.renderJoins();
  },

  renderJoins() {
    const joinsList = this.container.querySelector("#joins-list");
    if (!joinsList) return;

    const tableOptions = this.tables.map(t => {
      const displayName = t.schema ? `${t.schema}.${t.name}` : t.name;
      return `<option value="${t.name}">${displayName}${t.alias ? ' (' + t.alias + ')' : ''}</option>`;
    }).join('');

    joinsList.innerHTML = this.joins.map((join, index) => {
      // Get column suggestions for selected tables
      const leftTable = this.tables.find(t => t.name === join.leftTable);
      const rightTable = this.tables.find(t => t.name === join.rightTable);

      const leftColumnOptions = leftTable?.columns
        ? leftTable.columns.map(c => `<option value="${c.name}">${c.name}</option>`).join('')
        : '';
      const rightColumnOptions = rightTable?.columns
        ? rightTable.columns.map(c => `<option value="${c.name}">${c.name}</option>`).join('')
        : '';

      const showLeftDatalist = leftColumnOptions.length > 0;
      const showRightDatalist = rightColumnOptions.length > 0;

      return `
      <div class="join-row">
        <div class="join-field">
          <label>Left Table</label>
          <select class="join-left-table" data-index="${index}">
            <option value="">Select table</option>
            ${tableOptions}
          </select>
        </div>
        <div class="join-field">
          <label>Join Type</label>
          <select class="join-type" data-index="${index}">
            <option value="INNER JOIN" ${join.joinType === 'INNER JOIN' ? 'selected' : ''}>INNER JOIN</option>
            <option value="LEFT JOIN" ${join.joinType === 'LEFT JOIN' ? 'selected' : ''}>LEFT JOIN</option>
            <option value="RIGHT JOIN" ${join.joinType === 'RIGHT JOIN' ? 'selected' : ''}>RIGHT JOIN</option>
            <option value="FULL OUTER JOIN" ${join.joinType === 'FULL OUTER JOIN' ? 'selected' : ''}>FULL OUTER JOIN</option>
            <option value="CROSS JOIN" ${join.joinType === 'CROSS JOIN' ? 'selected' : ''}>CROSS JOIN</option>
          </select>
        </div>
        <div class="join-field">
          <label>Right Table</label>
          <select class="join-right-table" data-index="${index}">
            <option value="">Select table</option>
            ${tableOptions}
          </select>
        </div>
        <div class="join-field">
          <label>ON Left.Column</label>
          ${showLeftDatalist ? `
            <input type="text" list="left-columns-${index}" class="join-left-column" data-index="${index}" value="${join.leftColumn}" placeholder="Id">
            <datalist id="left-columns-${index}">
              ${leftColumnOptions}
            </datalist>
          ` : `
            <input type="text" class="join-left-column" data-index="${index}" value="${join.leftColumn}" placeholder="Id">
          `}
        </div>
        <div class="join-field">
          <label>= Right.Column</label>
          ${showRightDatalist ? `
            <input type="text" list="right-columns-${index}" class="join-right-column" data-index="${index}" value="${join.rightColumn}" placeholder="UserId">
            <datalist id="right-columns-${index}">
              ${rightColumnOptions}
            </datalist>
          ` : `
            <input type="text" class="join-right-column" data-index="${index}" value="${join.rightColumn}" placeholder="UserId">
          `}
        </div>
        <button class="remove-btn remove-join" data-index="${index}">Remove</button>
      </div>
    `;
    }).join('');

    // Set selected values
    this.joins.forEach((join, index) => {
      const leftSelect = joinsList.querySelector(`.join-left-table[data-index="${index}"]`);
      const rightSelect = joinsList.querySelector(`.join-right-table[data-index="${index}"]`);
      if (leftSelect) leftSelect.value = join.leftTable;
      if (rightSelect) rightSelect.value = join.rightTable;
    });

    // Attach event listeners
    joinsList.querySelectorAll('.join-left-table').forEach(select => {
      select.addEventListener('change', (e) => {
        this.joins[e.target.dataset.index].leftTable = e.target.value;
        this.renderJoins(); // Re-render to update column suggestions
      });
    });

    joinsList.querySelectorAll('.join-right-table').forEach(select => {
      select.addEventListener('change', (e) => {
        this.joins[e.target.dataset.index].rightTable = e.target.value;
        this.renderJoins(); // Re-render to update column suggestions
      });
    });

    joinsList.querySelectorAll('.join-type').forEach(select => {
      select.addEventListener('change', (e) => {
        this.joins[e.target.dataset.index].joinType = e.target.value;
      });
    });

    joinsList.querySelectorAll('.join-left-column').forEach(input => {
      input.addEventListener('input', (e) => {
        this.joins[e.target.dataset.index].leftColumn = e.target.value;
      });
    });

    joinsList.querySelectorAll('.join-right-column').forEach(input => {
      input.addEventListener('input', (e) => {
        this.joins[e.target.dataset.index].rightColumn = e.target.value;
      });
    });

    joinsList.querySelectorAll('.remove-join').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.removeJoin(parseInt(e.target.dataset.index));
      });
    });
  },

  removeJoin(index) {
    this.joins.splice(index, 1);
    this.renderJoins();
  },

  updateJoinSelects() {
    this.renderJoins();
  },

  generateSQL() {
    if (this.tables.length === 0) {
      alert('Please add at least one table');
      return;
    }

    const selectMode = this.container.querySelector("#select-mode")?.value || 'all';
    const columnList = this.container.querySelector("#column-list")?.value || '';

    let sql = 'SELECT\n    ';

    // SELECT clause
    if (selectMode === 'all') {
      sql += '*';
    } else if (selectMode === 'table-prefix') {
      sql += this.tables.map(t => {
        const alias = t.alias || t.name;
        return `${alias}.*`;
      }).join(',\n    ');
    } else if (selectMode === 'explicit') {
      sql += columnList || '*';
    }

    sql += '\nFROM\n';

    // FROM clause - first table
    const firstTable = this.tables[0];
    sql += `    ${firstTable.name}`;
    if (firstTable.alias) {
      sql += ` ${firstTable.alias}`;
    }
    sql += '\n';

    // JOIN clauses
    this.joins.forEach(join => {
      if (!join.leftTable || !join.rightTable) return;

      const leftAlias = this.tables.find(t => t.name === join.leftTable)?.alias || join.leftTable;
      const rightAlias = this.tables.find(t => t.name === join.rightTable)?.alias || join.rightTable;

      sql += `    ${join.joinType} ${join.rightTable}`;
      if (rightAlias !== join.rightTable) {
        sql += ` ${rightAlias}`;
      }

      if (join.joinType !== 'CROSS JOIN') {
        sql += ` ON ${leftAlias}.${join.leftColumn} = ${rightAlias}.${join.rightColumn}`;
      }

      sql += '\n';
    });

    sql += ';';

    this.context.setOutput(sql);
  },

  copyOutput() {
    const output = this.context.getOutput();
    if (output) {
      navigator.clipboard.writeText(output).then(() => {
        const copyBtn = this.container.querySelector("#copy-btn");
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "✓ Copied!";
        setTimeout(() => {
          copyBtn.textContent = originalText;
        }, 2000);
      });
    }
  },

  reset() {
    this.tables = [];
    this.joins = [];
    this.context.setOutput('');
    this.addTable('Users', 'u');
    this.addTable('Orders', 'o');
    this.addJoin();
  },

  onInput(input, context) {
    return { output: "" };
  }
};

// Standalone mode initialization
if (typeof window !== 'undefined' && !window.DevChef) {
  document.addEventListener('DOMContentLoaded', () => {
    const isStandalone = !document.querySelector('#workspace');

    if (isStandalone) {
      const standaloneContext = {
        input: "",
        output: "",
        setInput(val) { this.input = val; },
        setOutput(val) {
          this.output = val;
          const outputEl = document.querySelector("#output");
          if (outputEl) outputEl.value = val;
        },
        getInput() { return this.input; },
        getOutput() { return this.output; }
      };

      const template = document.querySelector('#tool-ui');
      if (template) {
        document.body.innerHTML = template.innerHTML;
        DevChefTool.init(document.body, standaloneContext);
      }
    }
  });
}
</script>

</body>
</html>

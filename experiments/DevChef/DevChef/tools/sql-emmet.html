<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL Emmet - DevChef Tool</title>
</head>
<body>

<!-- DevChef Manifest -->
<script type="devchef-manifest">
{
  "id": "sql-emmet",
  "name": "SQL Emmet",
  "category": "Database",
  "description": "Generate SQL with Emmet-like shorthand syntax from schema",
  "version": "1.0.0"
}
</script>

<!-- Tool UI Template -->
<template id="tool-ui">
  <div class="tool-container">
    <div class="tool-header">
      <h2 class="tool-title">SQL Emmet Generator</h2>
      <p class="tool-description">Generate SQL statements using Emmet-like shorthand syntax</p>
    </div>

    <div class="tool-section">
      <label class="section-label">Load Schema</label>
      <textarea id="json-schema-input" placeholder='Paste JSON schema here (format: {"tables": [{"name": "Users", "schema": "dbo", "columns": [{"name": "Id", "type": "INT", ...}, ...]}]})'></textarea>
      <div id="schema-status" class="schema-status"></div>
      <button id="load-schema-btn" class="secondary">Load Schema</button>
    </div>

    <div class="tool-section" id="table-select-section" style="display: none;">
      <label class="section-label">Select Table</label>
      <select id="table-selector"></select>
      <div id="table-info" class="table-info"></div>
    </div>

    <div class="tool-section">
      <label class="section-label">SQL Shorthand Command</label>
      <input type="text" id="shorthand-input" placeholder="Type command: s*, s id,name, i, u name='John', d id=1, j Orders on UserId" autocomplete="off">
      <div class="command-help">
        <strong>Quick Commands:</strong><br>
        <code>s*</code> - SELECT * <br>
        <code>s col1,col2</code> - SELECT specific columns<br>
        <code>s top 10</code> - SELECT TOP 10<br>
        <code>i</code> - INSERT with all columns<br>
        <code>i col1,col2</code> - INSERT specific columns<br>
        <code>u col=val</code> - UPDATE SET<br>
        <code>d</code> - DELETE FROM<br>
        <code>j TableName on Column</code> - INNER JOIN<br>
        <code>lj TableName on Column</code> - LEFT JOIN<br>
        <code>create</code> - CREATE TABLE<br>
        <code>sp name</code> - Stored Procedure template
      </div>
    </div>

    <div class="tool-section">
      <label class="section-label">Templates</label>
      <div class="template-buttons">
        <button class="template-btn" data-cmd="s*">SELECT *</button>
        <button class="template-btn" data-cmd="s top 10">SELECT TOP 10</button>
        <button class="template-btn" data-cmd="i">INSERT</button>
        <button class="template-btn" data-cmd="u">UPDATE</button>
        <button class="template-btn" data-cmd="d">DELETE</button>
        <button class="template-btn" data-cmd="create">CREATE TABLE</button>
        <button class="template-btn" data-cmd="merge">MERGE</button>
        <button class="template-btn" data-cmd="cte">CTE</button>
      </div>
    </div>

    <div class="tool-section">
      <button id="generate-btn">Generate SQL</button>
      <button id="copy-btn" class="secondary">Copy SQL</button>
      <button id="clear-btn" class="secondary">Clear</button>
    </div>

    <div class="tool-section">
      <label class="section-label" for="output">Generated SQL</label>
      <textarea id="output" readonly></textarea>
    </div>

    <div class="tool-section">
      <label class="section-label">Syntax Reference</label>
      <div class="syntax-reference">
        <div class="syntax-card">
          <h4>SELECT Queries</h4>
          <ul>
            <li><code>s*</code> → SELECT * FROM Table</li>
            <li><code>s col1,col2</code> → SELECT col1, col2 FROM Table</li>
            <li><code>s top 10</code> → SELECT TOP 10 * FROM Table</li>
            <li><code>s where id=1</code> → SELECT * FROM Table WHERE id=1</li>
            <li><code>s count</code> → SELECT COUNT(*) FROM Table</li>
          </ul>
        </div>
        <div class="syntax-card">
          <h4>INSERT Statements</h4>
          <ul>
            <li><code>i</code> → INSERT INTO Table (cols...) VALUES (...)</li>
            <li><code>i col1,col2</code> → INSERT specific columns</li>
            <li><code>i select</code> → INSERT INTO ... SELECT FROM ...</li>
          </ul>
        </div>
        <div class="syntax-card">
          <h4>UPDATE Statements</h4>
          <ul>
            <li><code>u</code> → UPDATE Table SET col=val</li>
            <li><code>u col1=val1,col2=val2</code> → Multiple columns</li>
            <li><code>u where id=1</code> → UPDATE with WHERE</li>
          </ul>
        </div>
        <div class="syntax-card">
          <h4>DELETE Statements</h4>
          <ul>
            <li><code>d</code> → DELETE FROM Table</li>
            <li><code>d where id=1</code> → DELETE with WHERE</li>
            <li><code>d top 100</code> → DELETE TOP 100</li>
          </ul>
        </div>
        <div class="syntax-card">
          <h4>JOIN Queries</h4>
          <ul>
            <li><code>j Orders on UserId</code> → INNER JOIN</li>
            <li><code>lj Orders on UserId</code> → LEFT JOIN</li>
            <li><code>rj Orders on UserId</code> → RIGHT JOIN</li>
            <li><code>fj Orders on UserId</code> → FULL OUTER JOIN</li>
          </ul>
        </div>
        <div class="syntax-card">
          <h4>Advanced</h4>
          <ul>
            <li><code>create</code> → CREATE TABLE statement</li>
            <li><code>merge</code> → MERGE statement template</li>
            <li><code>cte</code> → Common Table Expression</li>
            <li><code>sp ProcName</code> → Stored Procedure</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Tool Styles -->
<style>
  .schema-status {
    margin-top: 8px;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 13px;
    display: none;
  }

  .schema-status.success {
    display: block;
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .schema-status.error {
    display: block;
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .table-info {
    margin-top: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
    font-size: 13px;
    display: none;
  }

  .table-info.visible {
    display: block;
  }

  .table-info h4 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: var(--accent);
  }

  .table-info ul {
    margin: 0;
    padding-left: 20px;
  }

  .table-info li {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-secondary);
  }

  #shorthand-input {
    font-family: var(--font-mono);
    font-size: 16px;
    padding: 14px;
  }

  .command-help {
    margin-top: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
    font-size: 12px;
    line-height: 1.6;
  }

  .command-help code {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 11px;
  }

  .template-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
  }

  .template-btn {
    padding: 10px 16px;
    margin: 0;
    font-size: 13px;
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .template-btn:hover {
    background: var(--border-color);
  }

  #json-schema-input {
    min-height: 150px;
    font-family: var(--font-mono);
    font-size: 13px;
  }

  #output {
    min-height: 350px;
    font-family: var(--font-mono);
    font-size: 14px;
  }

  .syntax-reference {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }

  .syntax-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
  }

  .syntax-card h4 {
    margin: 0 0 12px 0;
    color: var(--accent);
    font-size: 14px;
  }

  .syntax-card ul {
    margin: 0;
    padding-left: 20px;
    list-style: none;
  }

  .syntax-card li {
    font-size: 12px;
    line-height: 1.8;
    color: var(--text-secondary);
  }

  .syntax-card code {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--accent);
  }

  @media (max-width: 768px) {
    .template-buttons {
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }

    .syntax-reference {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Standalone Styles -->
<style id="standalone-styles">
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e0e0e0;
    --border-color: #d0d0d0;
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --accent: #3498db;
    --accent-hover: #2980b9;
    --error: #e74c3c;
    --font-mono: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 24px;
    line-height: 1.6;
  }

  .tool-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .tool-header {
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border-color);
  }

  .tool-title {
    font-size: 32px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .tool-description {
    font-size: 16px;
    color: var(--text-secondary);
  }

  .tool-section {
    margin-bottom: 24px;
  }

  .section-label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input[type="text"],
  select,
  textarea {
    width: 100%;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px;
    font-family: var(--font-mono);
    font-size: 14px;
    border-radius: 6px;
    transition: all 0.2s;
  }

  textarea {
    min-height: 150px;
    resize: vertical;
  }

  button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--font-sans);
    margin-right: 8px;
  }

  button:hover {
    background: var(--accent-hover);
  }

  button.secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  button.secondary:hover {
    background: var(--border-color);
  }
</style>

<!-- Tool Module Logic -->
<script type="module">
export const DevChefTool = {
  container: null,
  context: null,
  schemaData: null,
  currentTable: null,

  init(container, context) {
    this.container = container;
    this.context = context;

    const loadSchemaBtn = container.querySelector("#load-schema-btn");
    const tableSelector = container.querySelector("#table-selector");
    const generateBtn = container.querySelector("#generate-btn");
    const copyBtn = container.querySelector("#copy-btn");
    const clearBtn = container.querySelector("#clear-btn");
    const shorthandInput = container.querySelector("#shorthand-input");

    loadSchemaBtn?.addEventListener("click", () => this.loadSchema());
    tableSelector?.addEventListener("change", (e) => this.selectTable(e.target.value));
    generateBtn?.addEventListener("click", () => this.generateSQL());
    copyBtn?.addEventListener("click", () => this.copyOutput());
    clearBtn?.addEventListener("click", () => this.clearOutput());

    // Real-time generation on Enter key
    shorthandInput?.addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        this.generateSQL();
      }
    });

    // Template buttons
    container.querySelectorAll(".template-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const cmd = e.target.dataset.cmd;
        shorthandInput.value = cmd;
        this.generateSQL();
      });
    });
  },

  loadSchema() {
    const jsonSchemaInput = this.container.querySelector("#json-schema-input");
    const schemaStatus = this.container.querySelector("#schema-status");
    const json = jsonSchemaInput?.value || '';

    if (!json.trim()) {
      this.showStatus('Please paste a JSON schema', 'error');
      return;
    }

    try {
      this.schemaData = JSON.parse(json);

      if (!this.schemaData.tables || !Array.isArray(this.schemaData.tables)) {
        this.showStatus('Invalid schema format. Expected: {"tables": [...]}', 'error');
        return;
      }

      if (this.schemaData.tables.length === 0) {
        this.showStatus('No tables found in schema', 'error');
        return;
      }

      // Populate table selector
      const tableSelector = this.container.querySelector("#table-selector");
      const tableSelectSection = this.container.querySelector("#table-select-section");

      tableSelector.innerHTML = this.schemaData.tables.map((table, index) =>
        `<option value="${index}">${table.schema || 'dbo'}.${table.name}</option>`
      ).join('');

      tableSelectSection.style.display = 'block';

      // Select first table by default
      this.selectTable(0);

      this.showStatus(`Successfully loaded ${this.schemaData.tables.length} table(s)!`, 'success');

    } catch (error) {
      this.showStatus(`Error parsing JSON: ${error.message}`, 'error');
      console.error(error);
    }
  },

  selectTable(index) {
    if (!this.schemaData || !this.schemaData.tables[index]) return;

    this.currentTable = this.schemaData.tables[index];

    // Display table info
    const tableInfo = this.container.querySelector("#table-info");
    const columnList = this.currentTable.columns.map(col => {
      const type = col.type || 'UNKNOWN';
      const nullable = col.nullable ? 'NULL' : 'NOT NULL';
      const pk = col.isPrimaryKey ? ' [PK]' : '';
      return `<li>${col.name} (${type}, ${nullable})${pk}</li>`;
    }).join('');

    tableInfo.innerHTML = `
      <h4>${this.currentTable.schema || 'dbo'}.${this.currentTable.name}</h4>
      <ul>${columnList}</ul>
    `;
    tableInfo.classList.add('visible');
  },

  showStatus(message, type) {
    const schemaStatus = this.container.querySelector("#schema-status");
    schemaStatus.textContent = message;
    schemaStatus.className = `schema-status ${type}`;
  },

  generateSQL() {
    const shorthand = this.container.querySelector("#shorthand-input")?.value.trim() || '';

    if (!shorthand) {
      this.context.setOutput('-- Enter a shorthand command to generate SQL');
      return;
    }

    if (!this.currentTable) {
      this.context.setOutput('-- Please load a schema and select a table first');
      return;
    }

    let sql = '';

    try {
      sql = this.parseShorthand(shorthand);
    } catch (error) {
      sql = `-- Error: ${error.message}`;
    }

    this.context.setOutput(sql);
  },

  parseShorthand(shorthand) {
    const cmd = shorthand.trim().toLowerCase();
    const table = this.currentTable;
    const tableName = `[${table.schema || 'dbo'}].[${table.name}]`;
    const columns = table.columns || [];

    // SELECT queries
    if (cmd.startsWith('s')) {
      return this.generateSelect(cmd, tableName, columns);
    }

    // INSERT statements
    if (cmd.startsWith('i')) {
      return this.generateInsert(cmd, tableName, columns);
    }

    // UPDATE statements
    if (cmd.startsWith('u')) {
      return this.generateUpdate(cmd, tableName, columns);
    }

    // DELETE statements
    if (cmd.startsWith('d')) {
      return this.generateDelete(cmd, tableName, columns);
    }

    // JOIN queries
    if (cmd.startsWith('j') || cmd.startsWith('lj') || cmd.startsWith('rj') || cmd.startsWith('fj')) {
      return this.generateJoin(cmd, tableName, columns);
    }

    // CREATE TABLE
    if (cmd === 'create') {
      return this.generateCreateTable(tableName, columns);
    }

    // MERGE
    if (cmd === 'merge') {
      return this.generateMerge(tableName, columns);
    }

    // CTE
    if (cmd === 'cte') {
      return this.generateCTE(tableName, columns);
    }

    // Stored Procedure
    if (cmd.startsWith('sp')) {
      return this.generateStoredProcedure(cmd, tableName, columns);
    }

    return '-- Unknown command. See syntax reference below.';
  },

  generateSelect(cmd, tableName, columns) {
    const parts = cmd.substring(1).trim();

    // SELECT *
    if (parts === '*' || parts === '') {
      return `SELECT *\nFROM ${tableName};`;
    }

    // SELECT TOP N
    if (parts.startsWith('top')) {
      const match = parts.match(/top\s+(\d+)/);
      const count = match ? match[1] : '10';
      return `SELECT TOP ${count} *\nFROM ${tableName};`;
    }

    // SELECT COUNT(*)
    if (parts === 'count') {
      return `SELECT COUNT(*) AS TotalCount\nFROM ${tableName};`;
    }

    // SELECT with WHERE
    if (parts.startsWith('where')) {
      const condition = parts.substring(5).trim();
      return `SELECT *\nFROM ${tableName}\nWHERE ${condition};`;
    }

    // SELECT specific columns
    const requestedCols = parts.split(',').map(c => c.trim());
    const columnList = requestedCols.map(col => {
      const found = columns.find(c => c.name.toLowerCase() === col.toLowerCase());
      return found ? `    [${found.name}]` : `    [${col}]`;
    }).join(',\n');

    return `SELECT\n${columnList}\nFROM ${tableName};`;
  },

  generateInsert(cmd, tableName, columns) {
    const parts = cmd.substring(1).trim();

    // INSERT ... SELECT
    if (parts === 'select') {
      const columnList = columns
        .filter(c => !c.isIdentity)
        .map(c => `    [${c.name}]`)
        .join(',\n');

      return `INSERT INTO ${tableName}\n(\n${columnList}\n)\nSELECT\n${columnList}\nFROM [SourceTable];`;
    }

    // Get columns to insert (exclude identity columns)
    let insertColumns = columns.filter(c => !c.isIdentity);

    // INSERT specific columns
    if (parts) {
      const requestedCols = parts.split(',').map(c => c.trim());
      insertColumns = requestedCols.map(col => {
        const found = columns.find(c => c.name.toLowerCase() === col.toLowerCase());
        return found || { name: col, type: 'UNKNOWN' };
      });
    }

    const columnList = insertColumns.map(c => `    [${c.name}]`).join(',\n');
    const valuesList = insertColumns.map(c => {
      const type = (c.type || '').toUpperCase();
      if (type.includes('INT') || type.includes('DECIMAL') || type.includes('NUMERIC')) {
        return `    0`;
      } else if (type.includes('BIT')) {
        return `    0`;
      } else if (type.includes('DATETIME') || type.includes('DATE')) {
        return `    GETUTCDATE()`;
      } else if (type.includes('UNIQUEIDENTIFIER')) {
        return `    NEWID()`;
      } else {
        return `    N'value'`;
      }
    }).join(',\n');

    return `INSERT INTO ${tableName}\n(\n${columnList}\n)\nVALUES\n(\n${valuesList}\n);`;
  },

  generateUpdate(cmd, tableName, columns) {
    const parts = cmd.substring(1).trim();

    let setClause = '';
    let whereClause = '';

    // Parse WHERE clause
    if (parts.includes('where')) {
      const whereSplit = parts.split('where');
      const setCols = whereSplit[0].trim();
      whereClause = `WHERE ${whereSplit[1].trim()}`;

      if (setCols) {
        setClause = this.parseSetClause(setCols, columns);
      } else {
        // Default to first non-PK column
        const col = columns.find(c => !c.isPrimaryKey) || columns[0];
        setClause = `    [${col.name}] = N'new value'`;
      }
    } else if (parts) {
      setClause = this.parseSetClause(parts, columns);
    } else {
      // Default UPDATE statement
      const col = columns.find(c => !c.isPrimaryKey) || columns[0];
      setClause = `    [${col.name}] = N'new value'`;
      const pkCol = columns.find(c => c.isPrimaryKey);
      if (pkCol) {
        whereClause = `WHERE [${pkCol.name}] = 1`;
      }
    }

    return `UPDATE ${tableName}\nSET\n${setClause}\n${whereClause};`;
  },

  parseSetClause(setCols, columns) {
    const assignments = setCols.split(',').map(assignment => {
      const parts = assignment.split('=');
      if (parts.length === 2) {
        const colName = parts[0].trim();
        const value = parts[1].trim();
        const found = columns.find(c => c.name.toLowerCase() === colName.toLowerCase());
        const finalCol = found ? found.name : colName;

        // Smart value formatting
        if (!isNaN(value)) {
          return `    [${finalCol}] = ${value}`;
        } else if (value.toUpperCase().startsWith('GET') || value.toUpperCase() === 'NEWID()') {
          return `    [${finalCol}] = ${value.toUpperCase()}`;
        } else {
          return `    [${finalCol}] = N'${value.replace(/'/g, "''")}'`;
        }
      }
      return `    ${assignment}`;
    });

    return assignments.join(',\n');
  },

  generateDelete(cmd, tableName, columns) {
    const parts = cmd.substring(1).trim();

    // DELETE TOP N
    if (parts.startsWith('top')) {
      const match = parts.match(/top\s+(\d+)/);
      const count = match ? match[1] : '100';
      return `DELETE TOP (${count})\nFROM ${tableName};`;
    }

    // DELETE with WHERE
    if (parts.startsWith('where')) {
      const condition = parts.substring(5).trim();
      return `DELETE FROM ${tableName}\nWHERE ${condition};`;
    }

    // Basic DELETE with PK WHERE
    const pkCol = columns.find(c => c.isPrimaryKey);
    const whereClause = pkCol ? `WHERE [${pkCol.name}] = 1` : '';

    return `DELETE FROM ${tableName}\n${whereClause};`;
  },

  generateJoin(cmd, tableName, columns) {
    let joinType = 'INNER JOIN';
    let parts = cmd;

    if (cmd.startsWith('lj')) {
      joinType = 'LEFT JOIN';
      parts = cmd.substring(2).trim();
    } else if (cmd.startsWith('rj')) {
      joinType = 'RIGHT JOIN';
      parts = cmd.substring(2).trim();
    } else if (cmd.startsWith('fj')) {
      joinType = 'FULL OUTER JOIN';
      parts = cmd.substring(2).trim();
    } else {
      parts = cmd.substring(1).trim();
    }

    // Parse: TableName on ColumnName
    const match = parts.match(/(\w+)\s+on\s+(\w+)/i);
    if (!match) {
      return '-- JOIN syntax: j TableName on ColumnName';
    }

    const joinTable = match[1];
    const joinColumn = match[2];

    // Find matching column in current table
    const matchCol = columns.find(c => c.name.toLowerCase() === joinColumn.toLowerCase());
    const leftCol = matchCol ? matchCol.name : joinColumn;

    // Assume right table has "Id" column
    const rightCol = 'Id';

    const t1Alias = this.currentTable.name.substring(0, 1).toLowerCase();
    const t2Alias = joinTable.substring(0, 1).toLowerCase();

    return `SELECT
    ${t1Alias}.*,
    ${t2Alias}.*
FROM ${tableName} ${t1Alias}
    ${joinType} [dbo].[${joinTable}] ${t2Alias}
        ON ${t1Alias}.[${leftCol}] = ${t2Alias}.[${rightCol}];`;
  },

  generateCreateTable(tableName, columns) {
    let sql = `CREATE TABLE ${tableName}\n(\n`;

    columns.forEach((col, index) => {
      sql += `    [${col.name}] ${col.type || 'NVARCHAR(100)'}`;

      if (col.isIdentity) {
        sql += ' IDENTITY(1,1)';
      }

      if (col.isPrimaryKey) {
        sql += ' PRIMARY KEY';
      }

      if (!col.nullable && !col.isPrimaryKey) {
        sql += ' NOT NULL';
      } else if (col.nullable) {
        sql += ' NULL';
      }

      if (index < columns.length - 1) {
        sql += ',';
      }

      sql += '\n';
    });

    sql += ');';
    return sql;
  },

  generateMerge(tableName, columns) {
    const pkCol = columns.find(c => c.isPrimaryKey) || columns[0];
    const nonPkCols = columns.filter(c => !c.isPrimaryKey && !c.isIdentity);

    const updateList = nonPkCols.map(c =>
      `        TARGET.[${c.name}] = SOURCE.[${c.name}]`
    ).join(',\n');

    const insertCols = columns.filter(c => !c.isIdentity).map(c => `[${c.name}]`).join(', ');
    const insertVals = columns.filter(c => !c.isIdentity).map(c => `SOURCE.[${c.name}]`).join(', ');

    return `MERGE ${tableName} AS TARGET
USING (
    SELECT * FROM [SourceTable]
) AS SOURCE
ON TARGET.[${pkCol.name}] = SOURCE.[${pkCol.name}]
WHEN MATCHED THEN
    UPDATE SET
${updateList}
WHEN NOT MATCHED BY TARGET THEN
    INSERT (${insertCols})
    VALUES (${insertVals})
WHEN NOT MATCHED BY SOURCE THEN
    DELETE;`;
  },

  generateCTE(tableName, columns) {
    const pkCol = columns.find(c => c.isPrimaryKey) || columns[0];

    return `WITH CTE_${this.currentTable.name} AS
(
    SELECT
        *
    FROM ${tableName}
    WHERE [${pkCol.name}] > 0
)
SELECT *
FROM CTE_${this.currentTable.name};`;
  },

  generateStoredProcedure(cmd, tableName, columns) {
    const parts = cmd.substring(2).trim();
    const procName = parts || `usp_Get${this.currentTable.name}`;
    const pkCol = columns.find(c => c.isPrimaryKey) || columns[0];

    return `CREATE PROCEDURE [dbo].[${procName}]
    @${pkCol.name} ${pkCol.type || 'INT'}
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM ${tableName}
    WHERE [${pkCol.name}] = @${pkCol.name};
END;`;
  },

  copyOutput() {
    const output = this.context.getOutput();
    if (output) {
      navigator.clipboard.writeText(output).then(() => {
        const copyBtn = this.container.querySelector("#copy-btn");
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "✓ Copied!";
        setTimeout(() => {
          copyBtn.textContent = originalText;
        }, 2000);
      });
    }
  },

  clearOutput() {
    this.context.setOutput('');
    this.container.querySelector("#shorthand-input").value = '';
  },

  onInput(input, context) {
    return { output: "" };
  }
};

// Standalone mode initialization
if (typeof window !== 'undefined' && !window.DevChef) {
  document.addEventListener('DOMContentLoaded', () => {
    const isStandalone = !document.querySelector('#workspace');

    if (isStandalone) {
      const standaloneContext = {
        input: "",
        output: "",
        setInput(val) { this.input = val; },
        setOutput(val) {
          this.output = val;
          const outputEl = document.querySelector("#output");
          if (outputEl) outputEl.value = val;
        },
        getInput() { return this.input; },
        getOutput() { return this.output; }
      };

      const template = document.querySelector('#tool-ui');
      if (template) {
        document.body.innerHTML = template.innerHTML;
        DevChefTool.init(document.body, standaloneContext);
      }
    }
  });
}
</script>

</body>
</html>

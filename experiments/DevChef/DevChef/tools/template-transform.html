<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Template Transform - DevChef Tool</title>
</head>
<body>

<!-- DevChef Manifest -->
<script type="devchef-manifest">
{
  "id": "template-transform",
  "name": "Template Transform",
  "category": "Development",
  "description": "Transform data using Jinja2-style templates with live preview",
  "version": "1.0.0"
}
</script>

<!-- Tool UI Template -->
<template id="tool-ui">
  <div class="tool-container">
    <div class="tool-header">
      <h2 class="tool-title">Template Transform Tool</h2>
      <p class="tool-description">Transform JSON data using Jinja2-style templating with live preview</p>
      <div class="mode-toggle">
        <button id="simplified-mode-btn" class="mode-btn active">Simplified</button>
        <button id="advanced-mode-btn" class="mode-btn">Advanced</button>
      </div>
    </div>

    <div id="simplified-section">
      <div class="tool-section">
        <label class="section-label">Quick Templates</label>
        <div class="templates-grid">
          <button class="template-card" data-template="sql-insert">
            <div class="template-icon">üíæ</div>
            <div class="template-name">SQL Insert</div>
          </button>
          <button class="template-card" data-template="sql-update">
            <div class="template-icon">üìù</div>
            <div class="template-name">SQL Update</div>
          </button>
          <button class="template-card" data-template="sql-merge">
            <div class="template-icon">üîÄ</div>
            <div class="template-name">SQL Merge</div>
          </button>
          <button class="template-card" data-template="html">
            <div class="template-icon">üåê</div>
            <div class="template-name">HTML Template</div>
          </button>
          <button class="template-card" data-template="config">
            <div class="template-icon">‚öôÔ∏è</div>
            <div class="template-name">Config File</div>
          </button>
          <button class="template-card" data-template="email">
            <div class="template-icon">üìß</div>
            <div class="template-name">Email Template</div>
          </button>
          <button class="template-card" data-template="xml">
            <div class="template-icon">üìÑ</div>
            <div class="template-name">XML/SOAP</div>
          </button>
          <button class="template-card" data-template="csv">
            <div class="template-icon">üìä</div>
            <div class="template-name">CSV Export</div>
          </button>
          <button class="template-card" data-template="markdown">
            <div class="template-icon">üìñ</div>
            <div class="template-name">Markdown Docs</div>
          </button>
          <button class="template-card" data-template="api-doc">
            <div class="template-icon">üîå</div>
            <div class="template-name">API Docs</div>
          </button>
          <button class="template-card" data-template="typescript">
            <div class="template-icon">üî∑</div>
            <div class="template-name">TypeScript</div>
          </button>
          <button class="template-card" data-template="docker">
            <div class="template-icon">üê≥</div>
            <div class="template-name">Docker Compose</div>
          </button>
          <button class="template-card" data-template="json-api">
            <div class="template-icon">üîó</div>
            <div class="template-name">JSON API</div>
          </button>
          <button class="template-card" data-template="csharp-class">
            <div class="template-icon">üîß</div>
            <div class="template-name">C# Class</div>
          </button>
          <button class="template-card" data-template="python-class">
            <div class="template-icon">üêç</div>
            <div class="template-name">Python Class</div>
          </button>
          <button class="template-card" data-template="java-class">
            <div class="template-icon">‚òï</div>
            <div class="template-name">Java Class</div>
          </button>
          <button class="template-card" data-template="kubernetes">
            <div class="template-icon">‚éà</div>
            <div class="template-name">Kubernetes</div>
          </button>
          <button class="template-card" data-template="terraform">
            <div class="template-icon">üèóÔ∏è</div>
            <div class="template-name">Terraform</div>
          </button>
          <button class="template-card" data-template="react-component">
            <div class="template-icon">‚öõÔ∏è</div>
            <div class="template-name">React Component</div>
          </button>
          <button class="template-card" data-template="graphql">
            <div class="template-icon">üìä</div>
            <div class="template-name">GraphQL Schema</div>
          </button>
          <button class="template-card" data-template="sql-table">
            <div class="template-icon">üóÑÔ∏è</div>
            <div class="template-name">CREATE TABLE</div>
          </button>
          <button class="template-card" data-template="rest-test">
            <div class="template-icon">üß™</div>
            <div class="template-name">REST API Test</div>
          </button>
        </div>
      </div>
    </div>

    <div class="editor-layout">
      <div class="editor-pane">
        <div class="tool-section">
          <label class="section-label" for="json-input">
            JSON Data
            <span class="hint">Enter your data in JSON format</span>
          </label>
          <textarea id="json-input" placeholder='{\n  "name": "John Doe",\n  "items": [1, 2, 3]\n}'></textarea>
          <div id="json-error" class="error-message"></div>
        </div>

        <div class="tool-section">
          <label class="section-label" for="template-input">
            Template
            <span class="hint">Use {{ variable }}, {% for %}, {% if %}</span>
          </label>
          <div class="template-toolbar">
            <button class="toolbar-btn" data-insert="{{ }}">{{ var }}</button>
            <button class="toolbar-btn" data-insert="{% for item in items %}\n  \n{% endfor %}">for loop</button>
            <button class="toolbar-btn" data-insert="{% if condition %}\n  \n{% endif %}">if</button>
            <button class="toolbar-btn" data-insert=" | upper">| upper</button>
            <button class="toolbar-btn" data-insert=" | lower">| lower</button>
          </div>
          <textarea id="template-input" placeholder="Hello {{ name }}!"></textarea>
          <div id="template-error" class="error-message"></div>
          <div id="autocomplete-popup" class="autocomplete-popup"></div>
        </div>
      </div>

      <div class="preview-pane">
        <div class="tool-section">
          <label class="section-label">
            Live Preview
            <button id="copy-output-btn" class="inline-btn">Copy Output</button>
          </label>
          <div id="preview-output"></div>
        </div>

        <div class="tool-section" id="advanced-options">
          <label class="section-label">Syntax Reference</label>
          <div class="syntax-reference">
            <div class="syntax-item">
              <code>{{ variable }}</code>
              <span>Insert variable value</span>
            </div>
            <div class="syntax-item">
              <code>{% for item in array %} ... {% endfor %}</code>
              <span>Loop through array</span>
            </div>
            <div class="syntax-item">
              <code>{% if condition %} ... {% endif %}</code>
              <span>Conditional rendering</span>
            </div>
            <div class="syntax-item">
              <code>{% if condition %} ... {% else %} ... {% endif %}</code>
              <span>Conditional with else</span>
            </div>
            <div class="syntax-item">
              <code>{{ value | upper }}</code>
              <span>Apply uppercase filter</span>
            </div>
            <div class="syntax-item">
              <code>{{ value | lower }}</code>
              <span>Apply lowercase filter</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Tool Styles -->
<style>
  .mode-toggle {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .mode-btn {
    padding: 8px 16px;
    font-size: 13px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mode-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }

  .template-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 20px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .template-card:hover {
    border-color: var(--accent);
    background: var(--bg-tertiary);
  }

  .template-icon {
    font-size: 32px;
  }

  .template-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .editor-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  .editor-pane,
  .preview-pane {
    min-width: 0;
  }

  .hint {
    font-size: 11px;
    font-weight: 400;
    color: var(--text-secondary);
    margin-left: 8px;
  }

  .template-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
  }

  .toolbar-btn {
    padding: 6px 10px;
    font-size: 11px;
    font-family: var(--font-mono);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .toolbar-btn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .inline-btn {
    padding: 4px 12px;
    font-size: 11px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-left: auto;
  }

  .section-label {
    display: flex;
    align-items: center;
  }

  #json-input,
  #template-input {
    min-height: 250px;
    font-family: var(--font-mono);
    font-size: 13px;
  }

  #preview-output {
    min-height: 520px;
    padding: 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 13px;
    white-space: pre-wrap;
    overflow-x: auto;
  }

  .error-message {
    display: none;
    margin-top: 8px;
    padding: 8px 12px;
    background: #fee;
    border: 1px solid #fcc;
    border-radius: 4px;
    color: #c33;
    font-size: 12px;
  }

  .error-message.show {
    display: block;
  }

  .autocomplete-popup {
    display: none;
    position: absolute;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
  }

  .autocomplete-popup.show {
    display: block;
  }

  .autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 12px;
  }

  .autocomplete-item:hover {
    background: var(--accent);
    color: white;
  }

  .syntax-reference {
    display: grid;
    gap: 12px;
  }

  .syntax-item {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 4px;
    font-size: 12px;
  }

  .syntax-item code {
    font-family: var(--font-mono);
    color: var(--accent);
    font-weight: 600;
  }

  .syntax-item span {
    color: var(--text-secondary);
  }

  #simplified-section {
    display: block;
  }

  #advanced-options {
    display: none;
  }

  .mode-advanced #simplified-section {
    display: none;
  }

  .mode-advanced #advanced-options {
    display: block;
  }

  @media (max-width: 1024px) {
    .editor-layout {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Standalone Styles -->
<style id="standalone-styles">
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e0e0e0;
    --border-color: #d0d0d0;
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --accent: #3498db;
    --accent-hover: #2980b9;
    --error: #e74c3c;
    --font-mono: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 24px;
    line-height: 1.6;
  }

  .tool-container {
    max-width: 1600px;
    margin: 0 auto;
  }

  .tool-header {
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border-color);
  }

  .tool-title {
    font-size: 32px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .tool-description {
    font-size: 16px;
    color: var(--text-secondary);
  }

  .tool-section {
    margin-bottom: 24px;
  }

  .section-label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input[type="text"],
  select,
  textarea {
    width: 100%;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px;
    font-family: var(--font-mono);
    font-size: 14px;
    border-radius: 6px;
    transition: all 0.2s;
  }

  textarea {
    min-height: 150px;
    resize: vertical;
  }

  button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--font-sans);
    margin-right: 8px;
  }

  button:hover {
    background: var(--accent-hover);
  }

  button.secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  button.secondary:hover {
    background: var(--border-color);
  }
</style>

<!-- Tool Module Logic -->
<script type="module">
export const DevChefTool = {
  container: null,
  context: null,
  currentMode: 'simplified',
  autocompleteKeys: [],

  templates: {
    'sql-insert': {
      json: JSON.stringify({
        table: 'Users',
        columns: ['FirstName', 'LastName', 'Email'],
        data: [
          { FirstName: 'John', LastName: 'Doe', Email: 'john@example.com' },
          { FirstName: 'Jane', LastName: 'Smith', Email: 'jane@example.com' }
        ]
      }, null, 2),
      template: `-- Insert statements for {{ table }}
{% for row in data %}
INSERT INTO [{{ table }}] ({% for col in columns %}[{{ col }}]{% if not loop.last %}, {% endif %}{% endfor %})
VALUES ({% for col in columns %}'{{ row[col] }}'{% if not loop.last %}, {% endif %}{% endfor %});
{% endfor %}`
    },
    'sql-update': {
      json: JSON.stringify({
        table: 'Users',
        keyColumn: 'Id',
        data: [
          { Id: 1, FirstName: 'John', LastName: 'Doe', Email: 'john.updated@example.com' },
          { Id: 2, FirstName: 'Jane', LastName: 'Smith', Email: 'jane.updated@example.com' }
        ]
      }, null, 2),
      template: `-- Update statements for {{ table }}
{% for row in data %}
UPDATE [{{ table }}]
SET FirstName = '{{ row.FirstName }}',
    LastName = '{{ row.LastName }}',
    Email = '{{ row.Email }}'
WHERE {{ keyColumn }} = {{ row.Id }};
{% endfor %}`
    },
    'sql-merge': {
      json: JSON.stringify({
        targetTable: 'Users',
        sourceTable: 'StagingUsers',
        keyColumn: 'Id',
        columns: ['FirstName', 'LastName', 'Email']
      }, null, 2),
      template: `MERGE INTO [{{ targetTable }}] AS target
USING [{{ sourceTable }}] AS source
ON target.{{ keyColumn }} = source.{{ keyColumn }}
WHEN MATCHED THEN
  UPDATE SET
{% for col in columns %}
    target.{{ col }} = source.{{ col }}{% if not loop.last %},{% endif %}
{% endfor %}
WHEN NOT MATCHED BY TARGET THEN
  INSERT ({{ keyColumn }}{% for col in columns %}, {{ col }}{% endfor %})
  VALUES (source.{{ keyColumn }}{% for col in columns %}, source.{{ col }}{% endfor %})
WHEN NOT MATCHED BY SOURCE THEN
  DELETE;`
    },
    'html': {
      json: JSON.stringify({
        title: 'My Page',
        heading: 'Welcome',
        items: ['Feature 1', 'Feature 2', 'Feature 3']
      }, null, 2),
      template: `<!DOCTYPE html>
<html>
<head>
  <title>{{ title }}</title>
</head>
<body>
  <h1>{{ heading }}</h1>
  <ul>
{% for item in items %}
    <li>{{ item }}</li>
{% endfor %}
  </ul>
</body>
</html>`
    },
    'config': {
      json: JSON.stringify({
        app: {
          name: 'MyApp',
          version: '1.0.0',
          debug: true
        },
        database: {
          host: 'localhost',
          port: 5432
        }
      }, null, 2),
      template: `# {{ app.name }} Configuration

[application]
name = "{{ app.name }}"
version = "{{ app.version }}"
debug = {% if app.debug %}true{% else %}false{% endif %}

[database]
host = "{{ database.host }}"
port = {{ database.port }}`
    },
    'email': {
      json: JSON.stringify({
        recipient: 'John Doe',
        product: 'Premium Plan',
        price: 99.99,
        features: ['Unlimited access', '24/7 support', 'Premium features']
      }, null, 2),
      template: `Dear {{ recipient }},

Thank you for your interest in {{ product }}!

Price: ${{ price }}

This plan includes:
{% for feature in features %}
  ‚úì {{ feature }}
{% endfor %}

Best regards,
The Team`
    },
    'xml': {
      json: JSON.stringify({
        requestId: '12345',
        items: [
          { id: 1, name: 'Product A', quantity: 5 },
          { id: 2, name: 'Product B', quantity: 3 }
        ]
      }, null, 2),
      template: `<?xml version="1.0" encoding="UTF-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <OrderRequest xmlns="http://example.com/orders">
      <RequestId>{{ requestId }}</RequestId>
      <Items>
{% for item in items %}
        <Item>
          <Id>{{ item.id }}</Id>
          <Name>{{ item.name }}</Name>
          <Quantity>{{ item.quantity }}</Quantity>
        </Item>
{% endfor %}
      </Items>
    </OrderRequest>
  </soap:Body>
</soap:Envelope>`
    },
    'csv': {
      json: JSON.stringify({
        headers: ['ID', 'Name', 'Email', 'Status'],
        rows: [
          { ID: 1, Name: 'John Doe', Email: 'john@example.com', Status: 'Active' },
          { ID: 2, Name: 'Jane Smith', Email: 'jane@example.com', Status: 'Inactive' }
        ]
      }, null, 2),
      template: `{% for header in headers %}{{ header }}{% if not loop.last %},{% endif %}{% endfor %}
{% for row in rows %}
{{ row.ID }},"{{ row.Name }}","{{ row.Email }}",{{ row.Status }}
{% endfor %}`
    },
    'markdown': {
      json: JSON.stringify({
        title: 'API Documentation',
        sections: [
          {
            heading: 'Authentication',
            content: 'Use Bearer token authentication',
            methods: ['POST /auth/login', 'POST /auth/refresh']
          },
          {
            heading: 'Users',
            content: 'User management endpoints',
            methods: ['GET /users', 'POST /users', 'PUT /users/:id']
          }
        ]
      }, null, 2),
      template: `# {{ title }}

{% for section in sections %}
## {{ section.heading }}

{{ section.content }}

**Endpoints:**
{% for method in section.methods %}
- \`{{ method }}\`
{% endfor %}

{% endfor %}`
    },
    'api-doc': {
      json: JSON.stringify({
        endpoints: [
          {
            method: 'GET',
            path: '/api/users',
            description: 'Get all users',
            params: [{ name: 'page', type: 'number', required: false }],
            response: { type: 'User[]' }
          },
          {
            method: 'POST',
            path: '/api/users',
            description: 'Create a new user',
            params: [{ name: 'name', type: 'string', required: true }],
            response: { type: 'User' }
          }
        ]
      }, null, 2),
      template: `# API Endpoints

{% for endpoint in endpoints %}
## {{ endpoint.method }} {{ endpoint.path }}

**Description:** {{ endpoint.description }}

**Parameters:**
{% for param in endpoint.params %}
- \`{{ param.name }}\` ({{ param.type }}){% if param.required %} - **Required**{% endif %}
{% endfor %}

**Response:** \`{{ endpoint.response.type }}\`

---

{% endfor %}`
    },
    'typescript': {
      json: JSON.stringify({
        interfaceName: 'User',
        properties: [
          { name: 'id', type: 'number', optional: false },
          { name: 'name', type: 'string', optional: false },
          { name: 'email', type: 'string', optional: false },
          { name: 'age', type: 'number', optional: true }
        ]
      }, null, 2),
      template: `interface {{ interfaceName }} {
{% for prop in properties %}
  {{ prop.name }}{% if prop.optional %}?{% endif %}: {{ prop.type }};
{% endfor %}
}

export type {{ interfaceName }}DTO = Partial<{{ interfaceName }}>;

export const create{{ interfaceName }} = (data: {{ interfaceName }}): {{ interfaceName }} => {
  return {
{% for prop in properties %}
    {{ prop.name }}: data.{{ prop.name }},
{% endfor %}
  };
};`
    },
    'docker': {
      json: JSON.stringify({
        services: [
          {
            name: 'web',
            image: 'node:18',
            ports: ['3000:3000'],
            environment: ['NODE_ENV=production']
          },
          {
            name: 'db',
            image: 'postgres:15',
            ports: ['5432:5432'],
            environment: ['POSTGRES_PASSWORD=secret']
          }
        ]
      }, null, 2),
      template: `version: '3.8'

services:
{% for service in services %}
  {{ service.name }}:
    image: {{ service.image }}
    ports:
{% for port in service.ports %}
      - "{{ port }}"
{% endfor %}
    environment:
{% for env in service.environment %}
      - {{ env }}
{% endfor %}
{% if not loop.last %}

{% endif %}
{% endfor %}`
    },
    'json-api': {
      json: JSON.stringify({
        users: [
          { id: 1, name: 'John Doe', email: 'john@example.com', active: true },
          { id: 2, name: 'Jane Smith', email: 'jane@example.com', active: false }
        ]
      }, null, 2),
      template: `{
  "data": [
{% for user in users %}
    {
      "type": "user",
      "id": "{{ user.id }}",
      "attributes": {
        "name": "{{ user.name }}",
        "email": "{{ user.email }}",
        "active": {{ user.active }}
      }
    }{% if not loop.last %},{% endif %}
{% endfor %}
  ]
}`
    },
    'csharp-class': {
      json: JSON.stringify({
        namespace: 'MyApp.Models',
        className: 'User',
        properties: [
          { name: 'Id', type: 'int', hasGetter: true, hasSetter: true },
          { name: 'FirstName', type: 'string', hasGetter: true, hasSetter: true },
          { name: 'Email', type: 'string', hasGetter: true, hasSetter: true }
        ]
      }, null, 2),
      template: `namespace {{ namespace }}
{
    public class {{ className }}
    {
{% for prop in properties %}
        public {{ prop.type }} {{ prop.name }} { {% if prop.hasGetter %}get;{% endif %} {% if prop.hasSetter %}set;{% endif %} }
{% endfor %}

        public {{ className }}()
        {
        }

        public {{ className }}({% for prop in properties %}{{ prop.type }} {{ prop.name | lower }}{% if not loop.last %}, {% endif %}{% endfor %})
        {
{% for prop in properties %}
            {{ prop.name }} = {{ prop.name | lower }};
{% endfor %}
        }
    }
}`
    },
    'python-class': {
      json: JSON.stringify({
        className: 'User',
        properties: [
          { name: 'id', type: 'int', default: '0' },
          { name: 'name', type: 'str', default: '""' },
          { name: 'email', type: 'str', default: '""' },
          { name: 'active', type: 'bool', default: 'False' }
        ],
        methods: [
          { name: 'get_display_name', returnType: 'str' },
          { name: 'activate', returnType: 'None' }
        ]
      }, null, 2),
      template: `class {{ className }}:
    """{{ className }} model class"""

    def __init__(self{% for prop in properties %}, {{ prop.name }}: {{ prop.type }} = {{ prop.default }}{% endfor %}):
{% for prop in properties %}
        self.{{ prop.name }} = {{ prop.name }}
{% endfor %}
{% for method in methods %}

    def {{ method.name }}(self) -> {{ method.returnType }}:
        """{{ method.name | upper }} method"""
        pass
{% endfor %}

    def __repr__(self):
        return f"{{ className }}({% for prop in properties %}{{ prop.name }}={self.{{ prop.name }}!r}{% if not loop.last %}, {% endif %}{% endfor %})"

    def __str__(self):
        return f"{{ className }}: {self.name}"`
    },
    'java-class': {
      json: JSON.stringify({
        package: 'com.example.models',
        className: 'User',
        properties: [
          { name: 'id', type: 'Long', description: 'User ID' },
          { name: 'username', type: 'String', description: 'Username' },
          { name: 'email', type: 'String', description: 'Email address' },
          { name: 'active', type: 'boolean', description: 'Active status' }
        ]
      }, null, 2),
      template: `package {{ package }};

import java.io.Serializable;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;

/**
 * {{ className }} entity class
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class {{ className }} implements Serializable {

    private static final long serialVersionUID = 1L;
{% for prop in properties %}

    /** {{ prop.description }} */
    private {{ prop.type }} {{ prop.name }};
{% endfor %}
}`
    },
    'kubernetes': {
      json: JSON.stringify({
        appName: 'my-app',
        namespace: 'production',
        replicas: 3,
        image: 'myapp:latest',
        port: 8080,
        env: [
          { name: 'NODE_ENV', value: 'production' },
          { name: 'DB_HOST', value: 'postgres-service' }
        ]
      }, null, 2),
      template: `apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ appName }}-deployment
  namespace: {{ namespace }}
  labels:
    app: {{ appName }}
spec:
  replicas: {{ replicas }}
  selector:
    matchLabels:
      app: {{ appName }}
  template:
    metadata:
      labels:
        app: {{ appName }}
    spec:
      containers:
      - name: {{ appName }}
        image: {{ image }}
        ports:
        - containerPort: {{ port }}
        env:
{% for var in env %}
        - name: {{ var.name }}
          value: "{{ var.value }}"
{% endfor %}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ appName }}-service
  namespace: {{ namespace }}
spec:
  selector:
    app: {{ appName }}
  ports:
  - protocol: TCP
    port: 80
    targetPort: {{ port }}
  type: LoadBalancer`
    },
    'terraform': {
      json: JSON.stringify({
        resources: [
          {
            type: 'aws_instance',
            name: 'web_server',
            ami: 'ami-0c55b159cbfafe1f0',
            instance_type: 't2.micro',
            tags: { Name: 'WebServer', Environment: 'Production' }
          },
          {
            type: 'aws_s3_bucket',
            name: 'data_bucket',
            bucket_name: 'my-data-bucket',
            tags: { Name: 'DataBucket', Environment: 'Production' }
          }
        ]
      }, null, 2),
      template: `{% for resource in resources %}
resource "{{ resource.type }}" "{{ resource.name }}" {
{% if resource.ami %}
  ami           = "{{ resource.ami }}"
{% endif %}
{% if resource.instance_type %}
  instance_type = "{{ resource.instance_type }}"
{% endif %}
{% if resource.bucket_name %}
  bucket = "{{ resource.bucket_name }}"
{% endif %}

  tags = {
{% for key, value in resource.tags %}
    {{ key }} = "{{ value }}"
{% endfor %}
  }
}

{% endfor %}`
    },
    'react-component': {
      json: JSON.stringify({
        componentName: 'UserCard',
        props: [
          { name: 'user', type: 'User', required: true },
          { name: 'onEdit', type: '() => void', required: false },
          { name: 'showDetails', type: 'boolean', required: false }
        ],
        hasState: true,
        stateVars: [
          { name: 'expanded', type: 'boolean', initial: 'false' }
        ]
      }, null, 2),
      template: `import React, { {% if hasState %}useState, {% endif %}FC } from 'react';

interface {{ componentName }}Props {
{% for prop in props %}
  {{ prop.name }}{% if not prop.required %}?{% endif %}: {{ prop.type }};
{% endfor %}
}

export const {{ componentName }}: FC<{{ componentName }}Props> = ({ {% for prop in props %}{{ prop.name }}{% if not loop.last %}, {% endif %}{% endfor %} }) => {
{% if hasState %}
{% for state in stateVars %}
  const [{{ state.name }}, set{{ state.name | upper }}] = useState<{{ state.type }}>({{ state.initial }});
{% endfor %}
{% endif %}

  return (
    <div className="{{ componentName | lower }}">
      {/* Component content */}
    </div>
  );
};`
    },
    'graphql': {
      json: JSON.stringify({
        types: [
          {
            name: 'User',
            fields: [
              { name: 'id', type: 'ID!', description: 'User ID' },
              { name: 'username', type: 'String!', description: 'Username' },
              { name: 'email', type: 'String!', description: 'Email address' },
              { name: 'posts', type: '[Post!]!', description: 'User posts' }
            ]
          },
          {
            name: 'Post',
            fields: [
              { name: 'id', type: 'ID!', description: 'Post ID' },
              { name: 'title', type: 'String!', description: 'Post title' },
              { name: 'content', type: 'String!', description: 'Post content' },
              { name: 'author', type: 'User!', description: 'Post author' }
            ]
          }
        ],
        queries: [
          { name: 'user', args: 'id: ID!', returns: 'User' },
          { name: 'posts', args: 'limit: Int', returns: '[Post!]!' }
        ]
      }, null, 2),
      template: `{% for type in types %}
"""{{ type.name }} type"""
type {{ type.name }} {
{% for field in type.fields %}
  """{{ field.description }}"""
  {{ field.name }}: {{ field.type }}
{% endfor %}
}

{% endfor %}
type Query {
{% for query in queries %}
  {{ query.name }}({{ query.args }}): {{ query.returns }}
{% endfor %}
}`
    },
    'sql-table': {
      json: JSON.stringify({
        schema: 'dbo',
        tableName: 'Users',
        columns: [
          { name: 'Id', type: 'INT', primaryKey: true, identity: true },
          { name: 'Username', type: 'NVARCHAR(50)', nullable: false, unique: true },
          { name: 'Email', type: 'NVARCHAR(255)', nullable: false },
          { name: 'CreatedAt', type: 'DATETIME2', nullable: false, default: 'GETUTCDATE()' },
          { name: 'IsActive', type: 'BIT', nullable: false, default: '1' }
        ],
        indexes: [
          { name: 'IX_Users_Email', columns: ['Email'] },
          { name: 'IX_Users_Username', columns: ['Username'], unique: true }
        ]
      }, null, 2),
      template: `CREATE TABLE [{{ schema }}].[{{ tableName }}] (
{% for col in columns %}
    [{{ col.name }}] {{ col.type }}{% if col.identity %} IDENTITY(1,1){% endif %}{% if col.primaryKey %} PRIMARY KEY{% endif %}{% if not col.nullable %} NOT NULL{% endif %}{% if col.default %} DEFAULT {{ col.default }}{% endif %}{% if col.unique and not col.primaryKey %} UNIQUE{% endif %}{% if not loop.last %},{% endif %}
{% endfor %}
);

{% for index in indexes %}
CREATE {% if index.unique %}UNIQUE {% endif %}INDEX [{{ index.name }}]
ON [{{ schema }}].[{{ tableName }}] ({% for col in index.columns %}[{{ col }}]{% if not loop.last %}, {% endif %}{% endfor %});

{% endfor %}`
    },
    'rest-test': {
      json: JSON.stringify({
        apiName: 'User API',
        baseUrl: 'https://api.example.com',
        tests: [
          {
            name: 'Get all users',
            method: 'GET',
            endpoint: '/users',
            expectedStatus: 200,
            assertions: ['response.data.length > 0', 'response.data[0].id']
          },
          {
            name: 'Create user',
            method: 'POST',
            endpoint: '/users',
            body: { username: 'testuser', email: 'test@example.com' },
            expectedStatus: 201,
            assertions: ['response.data.id', 'response.data.username === "testuser"']
          }
        ]
      }, null, 2),
      template: `describe('{{ apiName }}', () => {
  const baseUrl = '{{ baseUrl }}';
{% for test in tests %}

  test('{{ test.name }}', async () => {
    const response = await fetch(\`\${baseUrl}{{ test.endpoint }}\`, {
      method: '{{ test.method }}',
{% if test.body %}
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({{ test.body | tojson }}),
{% endif %}
    });

    expect(response.status).toBe({{ test.expectedStatus }});
    const data = await response.json();
{% for assertion in test.assertions %}
    expect({{ assertion }}).toBeTruthy();
{% endfor %}
  });
{% endfor %}
});`
    }
  },

  init(container, context) {
    this.container = container;
    this.context = context;

    const simplifiedModeBtn = container.querySelector("#simplified-mode-btn");
    const advancedModeBtn = container.querySelector("#advanced-mode-btn");
    const jsonInput = container.querySelector("#json-input");
    const templateInput = container.querySelector("#template-input");
    const copyOutputBtn = container.querySelector("#copy-output-btn");

    simplifiedModeBtn?.addEventListener("click", () => this.setMode('simplified'));
    advancedModeBtn?.addEventListener("click", () => this.setMode('advanced'));

    jsonInput?.addEventListener("input", () => this.render());
    templateInput?.addEventListener("input", () => this.render());
    templateInput?.addEventListener("keyup", (e) => this.handleAutocomplete(e));

    copyOutputBtn?.addEventListener("click", () => this.copyOutput());

    // Template card listeners
    container.querySelectorAll('.template-card').forEach(card => {
      card.addEventListener('click', (e) => {
        const templateId = e.currentTarget.dataset.template;
        this.loadTemplate(templateId);
      });
    });

    // Toolbar button listeners
    container.querySelectorAll('.toolbar-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const insert = e.target.dataset.insert;
        this.insertAtCursor(templateInput, insert);
      });
    });

    // Load default template
    this.loadTemplate('sql-insert');
  },

  setMode(mode) {
    this.currentMode = mode;
    const simplifiedBtn = this.container.querySelector("#simplified-mode-btn");
    const advancedBtn = this.container.querySelector("#advanced-mode-btn");

    if (mode === 'simplified') {
      simplifiedBtn.classList.add('active');
      advancedBtn.classList.remove('active');
      this.container.querySelector('.tool-container').classList.remove('mode-advanced');
    } else {
      advancedBtn.classList.add('active');
      simplifiedBtn.classList.remove('active');
      this.container.querySelector('.tool-container').classList.add('mode-advanced');
    }
  },

  loadTemplate(templateId) {
    const template = this.templates[templateId];
    if (!template) return;

    const jsonInput = this.container.querySelector("#json-input");
    const templateInput = this.container.querySelector("#template-input");

    jsonInput.value = template.json;
    templateInput.value = template.template;

    this.render();
  },

  insertAtCursor(textarea, text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const value = textarea.value;

    textarea.value = value.substring(0, start) + text + value.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
    textarea.focus();

    this.render();
  },

  handleAutocomplete(e) {
    const textarea = e.target;
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);

    // Check if we're typing inside {{ }}
    const match = textBefore.match(/\{\{\s*(\w*)$/);

    if (match && this.autocompleteKeys.length > 0) {
      const partial = match[1].toLowerCase();
      const suggestions = this.autocompleteKeys.filter(key =>
        key.toLowerCase().startsWith(partial)
      );

      if (suggestions.length > 0) {
        this.showAutocomplete(suggestions, textarea);
        return;
      }
    }

    this.hideAutocomplete();
  },

  showAutocomplete(suggestions, textarea) {
    const popup = this.container.querySelector("#autocomplete-popup");
    popup.innerHTML = suggestions.map(key =>
      `<div class="autocomplete-item" data-key="${key}">${key}</div>`
    ).join('');

    // Position popup
    const rect = textarea.getBoundingClientRect();
    popup.style.left = rect.left + 'px';
    popup.style.top = (rect.top + 100) + 'px';
    popup.classList.add('show');

    // Add click listeners
    popup.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', () => {
        const key = item.dataset.key;
        this.insertAutocomplete(textarea, key);
      });
    });
  },

  insertAutocomplete(textarea, key) {
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);

    const match = textBefore.match(/\{\{\s*(\w*)$/);
    if (match) {
      const newTextBefore = textBefore.substring(0, textBefore.length - match[1].length);
      textarea.value = newTextBefore + key + ' }}' + textAfter;
      textarea.selectionStart = textarea.selectionEnd = newTextBefore.length + key.length + 3;
    }

    this.hideAutocomplete();
    this.render();
  },

  hideAutocomplete() {
    const popup = this.container.querySelector("#autocomplete-popup");
    popup.classList.remove('show');
  },

  render() {
    const jsonInput = this.container.querySelector("#json-input");
    const templateInput = this.container.querySelector("#template-input");
    const jsonError = this.container.querySelector("#json-error");
    const templateError = this.container.querySelector("#template-error");
    const preview = this.container.querySelector("#preview-output");

    // Clear errors
    jsonError.classList.remove('show');
    templateError.classList.remove('show');

    // Parse JSON
    let data;
    try {
      data = JSON.parse(jsonInput.value || '{}');
      this.autocompleteKeys = this.extractKeys(data);
    } catch (e) {
      jsonError.textContent = 'Invalid JSON: ' + e.message;
      jsonError.classList.add('show');
      preview.textContent = '';
      return;
    }

    // Render template
    try {
      const result = this.renderTemplate(templateInput.value, data);
      preview.textContent = result;
      this.context.setOutput(result);
    } catch (e) {
      templateError.textContent = 'Template error: ' + e.message;
      templateError.classList.add('show');
      preview.textContent = '';
    }
  },

  extractKeys(obj, prefix = '') {
    let keys = [];
    for (const key in obj) {
      const fullKey = prefix ? `${prefix}.${key}` : key;
      keys.push(fullKey);
      if (typeof obj[key] === 'object' && !Array.isArray(obj[key]) && obj[key] !== null) {
        keys = keys.concat(this.extractKeys(obj[key], fullKey));
      }
    }
    return keys;
  },

  renderTemplate(template, data) {
    let result = template;

    // Process for loops
    result = this.processForLoops(result, data);

    // Process if statements
    result = this.processIfStatements(result, data);

    // Process variables with filters
    result = this.processVariables(result, data);

    return result;
  },

  processForLoops(template, data) {
    const forRegex = /\{%\s*for\s+(\w+)\s+in\s+([\w.]+)\s*%\}([\s\S]*?)\{%\s*endfor\s*%\}/g;

    return template.replace(forRegex, (match, itemVar, arrayPath, loopContent) => {
      const array = this.getNestedValue(data, arrayPath);

      if (!Array.isArray(array)) {
        throw new Error(`'${arrayPath}' is not an array`);
      }

      return array.map((item, index) => {
        const loopData = {
          ...data,
          [itemVar]: item,
          loop: {
            index: index,
            index0: index,
            index1: index + 1,
            first: index === 0,
            last: index === array.length - 1,
            length: array.length
          }
        };
        return this.processTemplate(loopContent, loopData);
      }).join('');
    });
  },

  processIfStatements(template, data) {
    const ifRegex = /\{%\s*if\s+([\w.]+)\s*%\}([\s\S]*?)(?:\{%\s*else\s*%\}([\s\S]*?))?\{%\s*endif\s*%\}/g;

    return template.replace(ifRegex, (match, condition, trueContent, falseContent) => {
      const value = this.getNestedValue(data, condition);
      const isTruthy = value && value !== 'false' && value !== '0';

      if (isTruthy) {
        return this.processTemplate(trueContent, data);
      } else if (falseContent) {
        return this.processTemplate(falseContent, data);
      }
      return '';
    });
  },

  processVariables(template, data) {
    const varRegex = /\{\{\s*([\w.]+(?:\[[\w.]+\])?)\s*(\|\s*(\w+))?\s*\}\}/g;

    return template.replace(varRegex, (match, varPath, filterPart, filterName) => {
      let value = this.getNestedValue(data, varPath);

      if (value === undefined || value === null) {
        return '';
      }

      // Apply filter if specified
      if (filterName) {
        value = this.applyFilter(value, filterName);
      }

      return String(value);
    });
  },

  processTemplate(template, data) {
    // Recursively process nested structures
    let result = template;
    result = this.processForLoops(result, data);
    result = this.processIfStatements(result, data);
    result = this.processVariables(result, data);
    return result;
  },

  getNestedValue(obj, path) {
    // Handle array access like row[col]
    const arrayAccessMatch = path.match(/^(\w+)\[(\w+)\]$/);
    if (arrayAccessMatch) {
      const arrayName = arrayAccessMatch[1];
      const keyName = arrayAccessMatch[2];
      const array = this.getNestedValue(obj, arrayName);
      const key = this.getNestedValue(obj, keyName);
      return array ? array[key] : undefined;
    }

    return path.split('.').reduce((current, key) => {
      return current ? current[key] : undefined;
    }, obj);
  },

  applyFilter(value, filterName) {
    switch (filterName) {
      case 'upper':
        return String(value).toUpperCase();
      case 'lower':
        return String(value).toLowerCase();
      case 'length':
        return Array.isArray(value) ? value.length : String(value).length;
      default:
        return value;
    }
  },

  copyOutput() {
    const output = this.context.getOutput();
    if (output) {
      navigator.clipboard.writeText(output).then(() => {
        const copyBtn = this.container.querySelector("#copy-output-btn");
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "‚úì Copied!";
        setTimeout(() => {
          copyBtn.textContent = originalText;
        }, 2000);
      });
    }
  },

  onInput(input, context) {
    return { output: "" };
  }
};

// Standalone mode initialization
if (typeof window !== 'undefined' && !window.DevChef) {
  document.addEventListener('DOMContentLoaded', () => {
    const isStandalone = !document.querySelector('#workspace');

    if (isStandalone) {
      const standaloneContext = {
        input: "",
        output: "",
        setInput(val) { this.input = val; },
        setOutput(val) {
          this.output = val;
        },
        getInput() { return this.input; },
        getOutput() { return this.output; }
      };

      const template = document.querySelector('#tool-ui');
      if (template) {
        document.body.innerHTML = template.innerHTML;
        DevChefTool.init(document.body, standaloneContext);
      }
    }
  });
}
</script>

</body>
</html>
